/*! For license information please see 4033.bundle.633e77b928de84dfaa50.js.LICENSE.txt */
(globalThis.webpackChunk=globalThis.webpackChunk||[]).push([[4033],{14041:(e,t,n)=>{"use strict";n.d(t,{fX:()=>s,W6:()=>gt,X6:()=>wa,f_:()=>ba,ql:()=>xa,QX:()=>va,_$:()=>c});var a={};n.r(a),n.d(a,{fillSegmentation:()=>Xe,generateSegmentation:()=>Ke,generateToolState:()=>Qe});var r={};n.r(r),n.d(r,{createFromDICOMSegBuffer:()=>Wn,generateLabelMaps2DFrom3D:()=>Mn,generateSegmentation:()=>An,generateToolState:()=>Yn});var i={};n.r(i),n.d(i,{generateToolState:()=>Xn});var o={};n.r(o),n.d(o,{generateContourSetsFromLabelmap:()=>Ta,generateRTSSFromAnnotations:()=>Ia,generateRTSSFromContour:()=>ha,generateRTSSFromLabelmap:()=>pa,generateRTSSFromRepresentation:()=>Oa,generateRTSSFromSegmentations:()=>fa});var s={};n.r(s),n.d(s,{s:()=>Re});var c={};n.r(c),n.d(c,{vk:()=>Fa});var u=n(5842);const d=e=>Array.isArray(e)?e:void 0!==e?[e]:[],l=e=>t=>t.ConceptNameCodeSequence.CodeMeaning===e;var m=n(15327);const{TID1500:g,addAccessors:f}=u.BF,{StructuredReport:p}=u.h4,{Normalizer:I}=u.z8,{TID1500MeasurementReport:S,TID1501MeasurementGroup:h}=g,{DicomMetaDictionary:O}=u.p,T={CodingSchemeDesignator:"DCM",CodeValue:"121071"},D={CodingSchemeDesignator:"SCT",CodeValue:"363698007"},R={CodingSchemeDesignator:"SRT",CodeValue:"G-C0E3"},C=(e,t,n)=>{const{ConceptNameCodeSequence:a}=e;if(!a)return;const{CodingSchemeDesignator:r,CodeValue:i}=a;return r==t.CodingSchemeDesignator&&i==t.CodeValue||n&&r==n.CodingSchemeDesignator&&i==n.CodeValue};class E{static getSetupMeasurementData(e){const{ContentSequence:t}=e,n=d(t),a=n.find(e=>C(e,T)),r=n.filter(e=>C(e,D,R))||[],i=n.find(e=>"NUM"===e.ValueType),o=d(i.ContentSequence).find(e=>"SCOORD"===e.ValueType),{ReferencedSOPSequence:s}=o.ContentSequence,{ReferencedSOPInstanceUID:c,ReferencedFrameNumber:u}=s,l={sopInstanceUid:c,frameIndex:u||1,complete:!0,finding:a?f(a.ConceptCodeSequence):void 0,findingSites:r.map(e=>f(e.ConceptCodeSequence))};l.finding&&(l.description=l.finding.CodeMeaning);const m=l.findingSites&&l.findingSites[0];return m&&(l.location=m[0]&&m[0].CodeMeaning||m.CodeMeaning),{defaultState:l,findingGroup:a,findingSiteGroups:r,NUMGroup:i,SCOORDGroup:o,ReferencedSOPSequence:s,ReferencedSOPInstanceUID:c,ReferencedFrameNumber:u}}static generateReport(e,t,n){let a=[];const r=Object.keys(e)[0];if(!r)throw new Error("No measurements provided.");const i=t.get("generalSeriesModule",r),{studyInstanceUID:o,seriesInstanceUID:s}=i;Object.keys(e).forEach(n=>{const r=t.get("sopCommonModule",n),i=t.get("frameNumber",n),o=e[n],s=Object.keys(o),c={ReferencedSOPClassUID:r.sopClassUID,ReferencedSOPInstanceUID:r.sopInstanceUID};I.isMultiframeSOPClassUID(r.sopClassUID)&&(c.ReferencedFrameNumber=i);const u=[];s.forEach(e=>{const t=function(e,t,n){const a=t[e],r=E.CORNERSTONE_TOOL_CLASSES_BY_TOOL_TYPE[e];if(!(a&&a.data&&a.data.length&&r))return;const i=a.data.map(e=>function(e,t,n){const a=n.getTID300RepresentationArguments(e);return a.ReferencedSOPSequence=t,a.ReferencedFrameOfReferenceUID=a.use3DSpatialCoordinates?e.metadata.FrameOfReferenceUID:null,new n.TID300Representation(a)}(e,n,r));return new h(i)}(e,o,c);t&&u.push(t)}),a=a.concat(u)});const c=new S({TID1501MeasurementGroups:a},n),u=new Uint8Array(2);u[1]=1;const d={StudyInstanceUID:o,SeriesInstanceUID:s},l={FileMetaInformationVersion:{Value:[u.buffer],vr:"OB"},TransferSyntaxUID:{Value:["1.2.840.10008.1.2.1"],vr:"UI"},ImplementationClassUID:{Value:[O.uid()],vr:"UI"},ImplementationVersionName:{Value:["dcmjs"],vr:"SH"}};d._meta=l,d._vrMap={PixelData:"OW"};const m=new p([d]),g=c.contentItem(d);return m.dataset=Object.assign(m.dataset,g),m.dataset._meta=l,m.dataset.SpecificCharacterSet="ISO_IR 192",m}static generateToolState(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if("1500"!==e.ContentTemplateSequence.TemplateIdentifier)throw new Error("This package can currently only interpret DICOM SR TID 1500");const n=d(e.ContentSequence).find(l("Imaging Measurements")),a=d(n.ContentSequence).filter(l("Measurement Group")),r={},i=E.CORNERSTONE_TOOL_CLASSES_BY_UTILITY_TYPE,o=[];return Object.keys(i).forEach(e=>{o.push(i[e]),r[e]=[]}),a.forEach(n=>{const a=d(n.ContentSequence).find(e=>"Tracking Identifier"===e.ConceptNameCodeSequence.CodeMeaning).TextValue,i=t.getToolClass?t.getToolClass(n,e,o):o.find(e=>e.isValidCornerstoneTrackingIdentifier(a));if(i){const e=i.getMeasurementData(n);console.log(`=== ${i.toolType} ===`),console.log(e),r[i.toolType].push(e)}}),r}static registerTool(e){E.CORNERSTONE_TOOL_CLASSES_BY_UTILITY_TYPE[e.utilityToolType]=e,E.CORNERSTONE_TOOL_CLASSES_BY_TOOL_TYPE[e.toolType]=e,E.MEASUREMENT_BY_TOOLTYPE[e.toolType]=e.utilityToolType}}E.MEASUREMENT_BY_TOOLTYPE={},E.CORNERSTONE_TOOL_CLASSES_BY_UTILITY_TYPE={},E.CORNERSTONE_TOOL_CLASSES_BY_TOOL_TYPE={};var y="cornerstoneTools@^4.0.0";const{Length:N}=u.BF.TID300,A="Length";class M{static getMeasurementData(e){const{defaultState:t,NUMGroup:n,SCOORDGroup:a}=E.getSetupMeasurementData(e),r={...t,length:n.MeasuredValueSequence.NumericValue,toolType:M.toolType,handles:{start:{},end:{},textBox:{hasMoved:!1,movesIndependently:!1,drawnIndependently:!0,allowedOutsideImage:!0,hasBoundingBox:!0}}};return[r.handles.start.x,r.handles.start.y,r.handles.end.x,r.handles.end.y]=a.GraphicData,r}static getTID300RepresentationArguments(e){const{handles:t,finding:n,findingSites:a}=e;return{point1:t.start,point2:t.end,distance:e.length,trackingIdentifierTextValue:"cornerstoneTools@^4.0.0:Length",finding:n,findingSites:a||[]}}}M.toolType=A,M.utilityToolType=A,M.TID300Representation=N,M.isValidCornerstoneTrackingIdentifier=e=>{if(!e.includes(":"))return!1;const[t,n]=e.split(":");return t===y&&n===A},E.registerTool(M);const{Polyline:P}=u.BF.TID300;class _{static getMeasurementData(e){const{defaultState:t,SCOORDGroup:n,NUMGroup:a}=E.getSetupMeasurementData(e),r={...t,toolType:_.toolType,handles:{points:[],textBox:{active:!1,hasMoved:!1,movesIndependently:!1,drawnIndependently:!0,allowedOutsideImage:!0,hasBoundingBox:!0}},cachedStats:{area:a?a.MeasuredValueSequence.NumericValue:0},color:void 0,invalidated:!0},{GraphicData:i}=n;for(let e=0;e<i.length;e+=2)r.handles.points.push({x:i[e],y:i[e+1]});return r}static getTID300RepresentationArguments(e){const{handles:t,finding:n,findingSites:a,cachedStats:r={}}=e,{points:i}=t,{area:o=0,perimeter:s=0}=r;return{points:i,area:o,perimeter:s,trackingIdentifierTextValue:"cornerstoneTools@^4.0.0:FreehandRoi",finding:n,findingSites:a||[]}}}_.toolType="FreehandRoi",_.utilityToolType="FreehandRoi",_.TID300Representation=P,_.isValidCornerstoneTrackingIdentifier=e=>{if(!e.includes(":"))return!1;const[t,n]=e.split(":");return t===y&&n===_.toolType},E.registerTool(_);const{Bidirectional:v}=u.BF.TID300,x="Bidirectional";class w{static getMeasurementData(e){const{ContentSequence:t}=e,n=d(t).find(e=>"121071"===e.ConceptNameCodeSequence.CodeValue),a=d(t).filter(e=>"G-C0E3"===e.ConceptNameCodeSequence.CodeValue),r=d(t).find(e=>"Long Axis"===e.ConceptNameCodeSequence.CodeMeaning),i=d(r.ContentSequence).find(e=>"SCOORD"===e.ValueType),o=d(t).find(e=>"Short Axis"===e.ConceptNameCodeSequence.CodeMeaning),s=d(o.ContentSequence).find(e=>"SCOORD"===e.ValueType),{ReferencedSOPSequence:c}=i.ContentSequence,{ReferencedSOPInstanceUID:u,ReferencedFrameNumber:l}=c,m=String(r.MeasuredValueSequence.NumericValue),g=String(o.MeasuredValueSequence.NumericValue),f=Math.max(i.GraphicData[0],i.GraphicData[2],s.GraphicData[0],s.GraphicData[2]),p=Math.max(i.GraphicData[1],i.GraphicData[3],s.GraphicData[1],s.GraphicData[3]);return{sopInstanceUid:u,frameIndex:l||1,toolType:w.toolType,active:!1,handles:{start:{x:i.GraphicData[0],y:i.GraphicData[1],drawnIndependently:!1,allowedOutsideImage:!1,active:!1,highlight:!1,index:0},end:{x:i.GraphicData[2],y:i.GraphicData[3],drawnIndependently:!1,allowedOutsideImage:!1,active:!1,highlight:!1,index:1},perpendicularStart:{x:s.GraphicData[0],y:s.GraphicData[1],drawnIndependently:!1,allowedOutsideImage:!1,active:!1,highlight:!1,index:2},perpendicularEnd:{x:s.GraphicData[2],y:s.GraphicData[3],drawnIndependently:!1,allowedOutsideImage:!1,active:!1,highlight:!1,index:3},textBox:{highlight:!1,hasMoved:!0,active:!1,movesIndependently:!1,drawnIndependently:!0,allowedOutsideImage:!0,hasBoundingBox:!0,x:f+10,y:p+10}},invalidated:!1,isCreating:!1,longestDiameter:m,shortestDiameter:g,toolName:"Bidirectional",visible:!0,finding:n?n.ConceptCodeSequence:void 0,findingSites:a.map(e=>e.ConceptCodeSequence)}}static getTID300RepresentationArguments(e){const{start:t,end:n,perpendicularStart:a,perpendicularEnd:r}=e.handles,{shortestDiameter:i,longestDiameter:o,finding:s,findingSites:c}=e;return{longAxis:{point1:t,point2:n},shortAxis:{point1:a,point2:r},longAxisLength:o,shortAxisLength:i,trackingIdentifierTextValue:"cornerstoneTools@^4.0.0:Bidirectional",finding:s,findingSites:c||[]}}}w.toolType=x,w.utilityToolType=x,w.TID300Representation=v,w.isValidCornerstoneTrackingIdentifier=e=>{if(!e.includes(":"))return!1;const[t,n]=e.split(":");return t===y&&n===x},E.registerTool(w);const{Ellipse:b}=u.BF.TID300,U="EllipticalRoi";class F{static getMeasurementData(e){const{defaultState:t,NUMGroup:n,SCOORDGroup:a}=E.getSetupMeasurementData(e),{GraphicData:r}=a,i=[{x:r[0],y:r[1]},{x:r[2],y:r[3]}],o=[{x:r[4],y:r[5]},{x:r[6],y:r[7]}],s=Math.sqrt(Math.pow(o[0].x-o[1].x,2)+Math.pow(o[0].y-o[1].y,2)),c=(o[1].x-o[0].x)/s,u=(o[1].y-o[0].y)/s,d=s/2,l={x:i[0].x+c*d,y:i[0].y+u*d},m={x:i[1].x-c*d,y:i[1].y-u*d};return{...t,toolType:F.toolType,active:!1,cachedStats:{area:n?n.MeasuredValueSequence.NumericValue:0},handles:{end:{x:l.x,y:l.y,highlight:!1,active:!1},initialRotation:0,start:{x:m.x,y:m.y,highlight:!1,active:!1},textBox:{hasMoved:!1,movesIndependently:!1,drawnIndependently:!0,allowedOutsideImage:!0,hasBoundingBox:!0}},invalidated:!0,visible:!0}}static getTID300RepresentationArguments(e){const{cachedStats:t={},handles:n,finding:a,findingSites:r}=e,{start:i,end:o}=n,{area:s}=t,c=Math.abs(i.x-o.x)/2,u=Math.abs(i.y-o.y)/2,d=[],l={x:(i.x+o.x)/2,y:(i.y+o.y)/2};c>u?(d.push({x:l.x-c,y:l.y}),d.push({x:l.x+c,y:l.y}),d.push({x:l.x,y:l.y-u}),d.push({x:l.x,y:l.y+u})):(d.push({x:l.x,y:l.y-u}),d.push({x:l.x,y:l.y+u}),d.push({x:l.x-c,y:l.y}),d.push({x:l.x+c,y:l.y}));return{area:s,points:d,trackingIdentifierTextValue:"cornerstoneTools@^4.0.0:EllipticalRoi",finding:a,findingSites:r||[]}}}F.toolType=U,F.utilityToolType=U,F.TID300Representation=b,F.isValidCornerstoneTrackingIdentifier=e=>{if(!e.includes(":"))return!1;const[t,n]=e.split(":");return t===y&&n===U},E.registerTool(F);const{Circle:q}=u.BF.TID300,G="CircleRoi";class L{static getMeasurementData(e){const{defaultState:t,NUMGroup:n,SCOORDGroup:a}=E.getSetupMeasurementData(e),{GraphicData:r}=a,i={x:r[0],y:r[1]},o={x:r[2],y:r[3]};return{...t,toolType:L.toolType,active:!1,cachedStats:{area:n?n.MeasuredValueSequence.NumericValue:0,radius:0,perimeter:0},handles:{end:{...o,highlight:!1,active:!1},initialRotation:0,start:{...i,highlight:!1,active:!1},textBox:{hasMoved:!1,movesIndependently:!1,drawnIndependently:!0,allowedOutsideImage:!0,hasBoundingBox:!0}},invalidated:!0,visible:!0}}static getTID300RepresentationArguments(e){const{cachedStats:t={},handles:n,finding:a,findingSites:r}=e,{start:i,end:o}=n,{area:s,radius:c}=t,u=2*Math.PI*c,d=[];d.push(i),d.push(o);return{area:s,perimeter:u,radius:c,points:d,trackingIdentifierTextValue:"cornerstoneTools@^4.0.0:CircleRoi",finding:a,findingSites:r||[]}}}L.toolType=G,L.utilityToolType=G,L.TID300Representation=q,L.isValidCornerstoneTrackingIdentifier=e=>{if(!e.includes(":"))return!1;const[t,n]=e.split(":");return t===y&&n===G},E.registerTool(L);const{Point:V}=u.BF.TID300,B="ArrowAnnotate",k="CORNERSTONEFREETEXT";class j{static getMeasurementData(e){const{defaultState:t,SCOORDGroup:n,findingGroup:a}=E.getSetupMeasurementData(e),{GraphicData:r}=n;return{...t,toolType:j.toolType,active:!1,handles:{start:{x:r[0],y:r[1],highlight:!0,active:!1},end:{x:4==r.length?r[2]:r[0]+20,y:4==r.length?r[3]:r[1]+20,highlight:!0,active:!1},textBox:{hasMoved:!1,movesIndependently:!1,drawnIndependently:!0,allowedOutsideImage:!0,hasBoundingBox:!0}},invalidated:!0,visible:!0}}static getTID300RepresentationArguments(e){const t=[e.handles.start,e.handles.end],{findingSites:n}=e;let{finding:a}=e;const r={points:t,trackingIdentifierTextValue:"cornerstoneTools@^4.0.0:ArrowAnnotate",findingSites:n||[]};return a&&a.CodeValue===k||(a={CodeValue:k,CodingSchemeDesignator:"CST4",CodeMeaning:e.label}),r.finding=a,r}}j.toolType=B,j.utilityToolType=B,j.TID300Representation=V,j.isValidCornerstoneTrackingIdentifier=e=>{if(!e.includes(":"))return!1;const[t,n]=e.split(":");return t===y&&n===B},E.registerTool(j);const{CobbAngle:$}=u.BF.TID300,z="CobbAngle";class H{static getMeasurementData(e){const{defaultState:t,NUMGroup:n,SCOORDGroup:a}=E.getSetupMeasurementData(e),r={...t,rAngle:n.MeasuredValueSequence.NumericValue,toolType:H.toolType,handles:{start:{},end:{},start2:{highlight:!0,drawnIndependently:!0},end2:{highlight:!0,drawnIndependently:!0},textBox:{hasMoved:!1,movesIndependently:!1,drawnIndependently:!0,allowedOutsideImage:!0,hasBoundingBox:!0}}};return[r.handles.start.x,r.handles.start.y,r.handles.end.x,r.handles.end.y,r.handles.start2.x,r.handles.start2.y,r.handles.end2.x,r.handles.end2.y]=a.GraphicData,r}static getTID300RepresentationArguments(e){const{handles:t,finding:n,findingSites:a}=e;return{point1:t.start,point2:t.end,point3:t.start2,point4:t.end2,rAngle:e.rAngle,trackingIdentifierTextValue:"cornerstoneTools@^4.0.0:CobbAngle",finding:n,findingSites:a||[]}}}H.toolType=z,H.utilityToolType=z,H.TID300Representation=$,H.isValidCornerstoneTrackingIdentifier=e=>{if(!e.includes(":"))return!1;const[t,n]=e.split(":");return t===y&&n===z},E.registerTool(H);const{Angle:Y}=u.BF.TID300,W="Angle";class K{static getMeasurementData(e){const{defaultState:t,NUMGroup:n,SCOORDGroup:a}=E.getSetupMeasurementData(e),r={...t,rAngle:n.MeasuredValueSequence.NumericValue,toolType:K.toolType,handles:{start:{},middle:{},end:{},textBox:{hasMoved:!1,movesIndependently:!1,drawnIndependently:!0,allowedOutsideImage:!0,hasBoundingBox:!0}}};return[r.handles.start.x,r.handles.start.y,r.handles.middle.x,r.handles.middle.y,r.handles.middle.x,r.handles.middle.y,r.handles.end.x,r.handles.end.y]=a.GraphicData,r}static getTID300RepresentationArguments(e){const{handles:t,finding:n,findingSites:a}=e;return{point1:t.start,point2:t.middle,point3:t.middle,point4:t.end,rAngle:e.rAngle,trackingIdentifierTextValue:"cornerstoneTools@^4.0.0:Angle",finding:n,findingSites:a||[]}}}K.toolType=W,K.utilityToolType=W,K.TID300Representation=Y,K.isValidCornerstoneTrackingIdentifier=e=>{if(!e.includes(":"))return!1;const[t,n]=e.split(":");return t===y&&n===W},E.registerTool(K);const{Polyline:Q}=u.BF.TID300;class X{static getMeasurementData(e){const{defaultState:t,SCOORDGroup:n,NUMGroup:a}=E.getSetupMeasurementData(e),r={...t,toolType:X.toolType,handles:{start:{},end:{},textBox:{active:!1,hasMoved:!1,movesIndependently:!1,drawnIndependently:!0,allowedOutsideImage:!0,hasBoundingBox:!0},initialRotation:0},cachedStats:{area:a?a.MeasuredValueSequence.NumericValue:0},color:void 0,invalidated:!0},i={};return[r.handles.start.x,r.handles.start.y,i.x,i.y,r.handles.end.x,r.handles.end.y]=n.GraphicData,r}static getTID300RepresentationArguments(e){const{finding:t,findingSites:n,cachedStats:a={},handles:r}=e,{start:i,end:o}=r,s=[i,{x:i.x,y:o.y},o,{x:o.x,y:i.y}],{area:c,perimeter:u}=a;return{points:s,area:c,perimeter:u,trackingIdentifierTextValue:"cornerstoneTools@^4.0.0:RectangleRoi",finding:t,findingSites:n||[]}}}X.toolType="RectangleRoi",X.utilityToolType="RectangleRoi",X.TID300Representation=Q,X.isValidCornerstoneTrackingIdentifier=e=>{if(!e.includes(":"))return!1;const[t,n]=e.split(":");return t===y&&n===X.toolType},E.registerTool(X);var J=n(3293),Z=n.n(J);const{DicomMessage:ee,DicomMetaDictionary:te}=u.p,{Normalizer:ne}=u.z8;function ae(e,t,n){const a=[];if(t){const t=e[0].data.byteArray.buffer,n=ee.readFile(t),r=te.naturalizeDataset(n.dict);r._meta=te.namifyDataset(n.meta),a.push(r)}else for(let t=0;t<e.length;t++){const n=e[t].data.byteArray.buffer,r=ee.readFile(n),i=te.naturalizeDataset(r.dict);i._meta=te.namifyDataset(r.meta),a.push(i)}return n?.SpecificCharacterSet&&a.forEach(e=>e.SpecificCharacterSet=n.SpecificCharacterSet),ne.normalizeToDataset(a)}const{rotateDirectionCosinesInPlane:re,flipImageOrientationPatient:ie,flipMatrix2D:oe,rotateMatrix902D:se}=u.BF.orientation,{datasetToBlob:ce,BitArray:ue,DicomMessage:de,DicomMetaDictionary:le}=u.BF,{Normalizer:me}=u.z8,{Segmentation:ge}=u.h4,fe={generateSegmentation:function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{includeSliceSpacing:!0};const{toolState:a,segments:r}=t,i=e[0],o={x:i.columns,y:i.rows,z:e.length};o.xy=o.x*o.y;if(!function(e,t){let n=0;for(let e=0;e<t.length;e++)t[e]&&n++;return n}(0,r))throw new Error("No segments to export!");const s=i.imageId.includes("?frame"),c=function(e,t,n){const a=ae(e,t);return new ge([a],n)}(e,s,n),{referencedFramesPerSegment:u,segmentIndicies:d}=function(e,t,n){const a=[],r=[];for(let e=0;e<n.length;e++)n[e]&&(a.push(e),r.push([]));for(let n=0;n<t.length;n++){const i=e[t[n].imageId];for(let e=0;e<a.length;e++){const t=a[e];i&&i.brush&&i.brush.data&&i.brush.data[t]&&i.brush.data[t].pixelData&&r[e].push(n)}}return{referencedFramesPerSegment:r,segmentIndicies:a}}(a,e,r);let l=0;for(let e=0;e<u.length;e++)l+=u[e].length;c.setNumberOfFrames(l);for(let t=0;t<d.length;t++){const n=d[t],i=u[t],s=i.map(e=>e+1),l=r[n];c.addSegment(l,pe(n,i,a,e,o),s)}c.bitPackPixelData();return ce(c.dataset)},generateToolState:function(e,t,n){const a=de.readFile(t),r=le.naturalizeDataset(a.dict);r._meta=le.namifyDataset(a.meta);const i=me.normalizeToDataset([r]),o=n.get("imagePlaneModule",e[0]);o||console.warn("Insufficient metadata, imagePlaneModule missing.");const s=function(e){const t=[];t[0]=e,t[1]=ie.h(e),t[2]=ie.v(e);const n=re(e,Math.PI/2);return t[3]=n,t[4]=ie.h(n),t[5]=ie.v(n),t[6]=re(e,Math.PI),t[7]=re(e,1.5*Math.PI),t}(Array.isArray(o.rowCosines)?[...o.rowCosines,...o.columnCosines]:[o.rowCosines.x,o.rowCosines.y,o.rowCosines.z,o.columnCosines.x,o.columnCosines.y,o.columnCosines.z]),c=i.SharedFunctionalGroupsSequence,d=c.PlaneOrientationSequence?c.PlaneOrientationSequence.ImageOrientationPatient:void 0,l=i.Columns*i.Rows,m=function(e){const t=[],n=e.SegmentSequence;if(Array.isArray(n))for(let e=0;e<n.length;e++)t.push(n[e]);else t.push(n);return{seriesInstanceUid:e.ReferencedSeriesSequence.SeriesInstanceUID,data:t}}(i),g=function(e){const t=e.SegmentationType;if("BINARY"===t)return ue.unpack(e.PixelData);const n=new Uint8Array(e.PixelData),a=e.MaximumFractionalValue,r=void 0===n.find(e=>0!==e&&e!==a);if(!r)return void u.Rm.warn("This is a fractional segmentation, which is not currently supported.");return u.Rm.warn("This segmentation object is actually binary... processing as such."),n}(i),f=i.PerFrameFunctionalGroupsSequence,p={};let I=!0;for(let t=0;t<f.length;t++){const a=f[t],r=d||a.PlaneOrientationSequence.ImageOrientationPatient,o=he(Z()(new Uint8Array(g.buffer,t*l,l),[i.Rows,i.Columns]),r,s);if(!o){console.warn("This segmentation object is not in-plane with the source data. Bailing out of IO. It'd be better to render this with vtkjs. "),I=!1;break}const u=a.SegmentIdentificationSequence.ReferencedSegmentNumber-1;let m;m=c.DerivationImageSequence&&c.DerivationImageSequence.SourceImageSequence?c.DerivationImageSequence.SourceImageSequence[t]:a.DerivationImageSequence.SourceImageSequence;Ie(p,Se(m,e,n),u,o)}if(!I)return;return{toolState:p,segMetadata:m}}};function pe(e,t,n,a,r){const i=new Uint8Array(r.xy*t.length);let o=0;for(let r=0;r<t.length;r++){const s=n[a[t[r]].imageId].brush.data[e].pixelData;for(let e=0;e<s.length;e++)i[o]=s[e],o++}return i}function Ie(e,t,n,a){e[t]?e[t].brush?e[t].brush.data||(e[t].brush.data=[]):(e[t].brush={},e[t].brush.data=[]):(e[t]={},e[t].brush={},e[t].brush.data=[]),e[t].brush.data[n]={};const r=e[t].brush.data[n];r.pixelData=new Uint8Array(a.data.length);const i=r.pixelData;for(let e=0;e<i.length;e++)a.data[e]?i[e]=1:i[e]=0}function Se(e,t,n){const{ReferencedSOPInstanceUID:a,ReferencedFrameNumber:r}=e;return r?function(e,t,n,a){const r=n.find(n=>{const r=a.get("sopCommonModule",n);if(!r)return;const i=Number(n.split("frame=")[1]);return r.sopInstanceUID===e&&i===t-1});return r}(a,r,t,n):function(e,t,n){return t.find(t=>{const a=n.get("sopCommonModule",t);if(a)return a.sopInstanceUID===e})}(a,t,n)}function he(e,t,n){return Te(t,n[0])?e:Te(t,n[1])?oe.v(e):Te(t,n[2])?oe.h(e):Te(t,n[3])?se(e):Te(t,n[4])?oe.h(se(e)):Te(t,n[5])?oe.v(se(e)):Te(t,n[6])?se(se(e)):Te(t,n[7])?se(se(se(e))):void 0}const Oe=1e-5;function Te(e,t){return Math.abs(e[0]-t[0])<Oe&&Math.abs(e[1]-t[1])<Oe&&Math.abs(e[2]-t[2])<Oe&&Math.abs(e[3]-t[3])<Oe&&Math.abs(e[4]-t[4])<Oe&&Math.abs(e[5]-t[5])<Oe}function De(e,t,n,a){const{SharedFunctionalGroupsSequence:r,PerFrameFunctionalGroupsSequence:i}=e,o=r.PlaneOrientationSequence?r.PlaneOrientationSequence.ImageOrientationPatient:void 0,s=i[0],c=o||s.PlaneOrientationSequence.ImageOrientationPatient;return t.some(e=>m.utilities.isEqual(c,e,a))?"Planar":function(e,t,n){const a=Math.abs(e[0]*t[0]+e[1]*t[1]+e[2]*t[2]),r=Math.abs(e[3]*t[3]+e[4]*t[4]+e[5]*t[5]);return(a<n||Math.abs(a-1)<n)&&(r<n||Math.abs(r-1)<n)}(c,t[0],a)&&n.includes(e.Rows)&&n.includes(e.Columns)?"Perpendicular":"Oblique"}var Re;!function(e){e.SEGMENTATION_LOAD_PROGRESS="CORNERSTONE_ADAPTER_SEGMENTATION_LOAD_PROGRESS"}(Re||(Re={}));const{rotateDirectionCosinesInPlane:Ce,flipImageOrientationPatient:Ee,flipMatrix2D:ye,rotateMatrix902D:Ne}=u.BF.orientation,{BitArray:Ae,DicomMessage:Me,DicomMetaDictionary:Pe}=u.p,{Normalizer:_e}=u.z8,{Segmentation:ve}=u.h4,{encode:xe,decode:we}=u.BF.compression,be={includeSliceSpacing:!0,rleEncode:!1};function Ue(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};const a=Object.assign({},be,n),r=Array.isArray(t)?t:[t];let i=0;const o=[];for(let e=0;e<r.length;e++){const t=r[e],{labelmaps2D:n,metadata:a}=t,s=[];for(let e=1;e<a.length;e++)a[e]&&(s[e]=[]);for(let e=0;e<n.length;e++){const t=n[e];if(n[e]){const{segmentsOnLabelmap:n}=t;n.forEach(t=>{0!==t&&(s[t].push(e),i++)})}}o[e]=s}e.setNumberOfFrames(i);for(let t=0;t<r.length;t++){const n=o[t],a=r[t],{metadata:i}=a;for(let t=1;t<n.length;t++){const r=n[t];if(r){const n=r.map(e=>e+1),o=i[t],s=Fe(a,r);e.addSegmentFromLabelmap(o,s,t,n)}}}if(a.rleEncode){const t=xe(e.dataset.PixelData,i,e.dataset.Rows,e.dataset.Columns);e.assignToDataset({BitsAllocated:"8",BitsStored:"8",HighBit:"7",SegmentationType:"FRACTIONAL",SegmentationFractionalType:"PROBABILITY",MaximumFractionalValue:"255"}),e.dataset._meta.TransferSyntaxUID={Value:["1.2.840.10008.1.2.5"],vr:"UI"},e.dataset.SpecificCharacterSet="ISO_IR 192",e.dataset._vrMap.PixelData="OB",e.dataset.PixelData=t}else e.bitPackPixelData();return e}function Fe(e,t){const{labelmaps2D:n}=e,a=[];for(let e=0;e<t.length;e++){const r=t[e];a.push(n[r].pixelData)}return a}function qe(e,t,n,a,r,i){let o;if(!e)return o;const{FrameOfReferenceUID:s,PerFrameFunctionalGroupsSequence:c,SourceImageSequence:u,ReferencedSeriesSequence:d}=e;if(!c||0===c.length)return o;const l=c[t];if(!l)return o;let g;if(l.DerivationImageSequence){let e=l.DerivationImageSequence;Array.isArray(e)&&(e=0!==e.length?e[0]:void 0),e&&(g=e.SourceImageSequence,Array.isArray(g)&&(g=0!==g.length?g[0]:void 0))}else u&&0!==u.length&&(console.warn("DerivationImageSequence not present, using SourceImageSequence assuming SEG has the same geometry as the source image."),g=u[t]);if(g&&(o=function(e,t){const{ReferencedSOPInstanceUID:n,ReferencedFrameNumber:a}=e,r=t[n];if(!r)return void console.warn(`No imageId found for SOPInstanceUID: ${n}`);if(void 0!==a)return r.includes("frames/")?r.replace(/frames\/\d+/,`frames/${a}`):r.includes("dicomfile:")?r.replace(/frame=\d+/,`frame=${a}`):r.includes("frame=")?r.replace(/frame=\d+/,"frame="+(a-1)):r.includes("wadors:")?`${r}/frames/${a}`:`${r}?frame=${a-1}`;return r}(g,i)),void 0===o&&d){o=function(e,t,n,a,r,i){if(!e||!n.PlanePositionSequence?.[0]?.ImagePositionPatient)return;const o=n.PlanePositionSequence[0].ImagePositionPatient;for(let n of a){const a=r.get("instance",n);if(!a)continue;const s=ke(a);if(a.ImagePositionPatient&&a.FrameOfReferenceUID===t&&a.SeriesInstanceUID===e)if(s){const e=r.get("imagePlaneModule",n)?.imagePositionPatient;if(e&&m.utilities.isEqual(o,e,i))return n}else if(m.utilities.isEqual(o,a.ImagePositionPatient,i))return n}return}((Array.isArray(d)?d[0]:d).SeriesInstanceUID,s,l,n,a,r)}return o}function Ge(e,t,n,a,r,i,o,s,c,u,d,l){const{SharedFunctionalGroupsSequence:m,PerFrameFunctionalGroupsSequence:g,Rows:f,Columns:p}=r,I=m.PlaneOrientationSequence?m.PlaneOrientationSequence.ImageOrientationPatient:void 0,S=p*f,h=S*i.length*u.BYTES_PER_ELEMENT;let O=1,T=0,D=n[T].slice(0),R=structuredClone(t[T]),C=r.SegmentSequence.length;for(let d=1;d<=C;++d){for(let m=0,C=g.length;m<C;++m){const C=g[m],E=Le(r,m);if(void 0===E)throw new Error("Could not retrieve the segment index. Aborting segmentation loading.");if(E!==d)continue;const y=I||C.PlaneOrientationSequence.ImageOrientationPatient,N=He(a,m*S,S),A=$e(Z()(N,[f,p]),y,o,c);if(!A)throw new Error("Individual SEG frames are out of plane with respect to the first SEG frame. This is not yet supported. Aborting segmentation loading.");const M=qe(r,m,i,s,c,l);if(!M){console.warn("Image not present in stack, can't import frame : "+m+".");continue}const P=s.get("instance",M);if(f!==P.Rows||p!==P.Columns)throw new Error("Individual SEG frames have different geometry dimensions (Rows and Columns) respect to the source image reference frame. This is not yet supported. Aborting segmentation loading. ");const _=i.findIndex(e=>e===M),v=new u(D,S*_*u.BYTES_PER_ELEMENT,S),x=A.data;let w=!1;for(let e=0,a=A.data.length;e<a;++e)if(x[e]){if(0!==v[e]){T++,T>=O&&(n[T]=new ArrayBuffer(h),t[T]=[],O++),D=n[T].slice(0),R=structuredClone(t[T]),m=0;break}v[e]=E,w=!0}w&&(R[_]||(R[_]=[]),R[_].push(E),e[_]||(e[_]=[]),e[_].push(E))}n[T]=D.slice(0),t[T]=structuredClone(R),T=0,D=n[T].slice(0),R=structuredClone(t[T])}}const Le=(e,t)=>{const{PerFrameFunctionalGroupsSequence:n,SharedFunctionalGroupsSequence:a}=e,r=n[t];return r&&r.SegmentIdentificationSequence?r.SegmentIdentificationSequence.ReferencedSegmentNumber:a.SegmentIdentificationSequence?a.SegmentIdentificationSequence.ReferencedSegmentNumber:void 0};function Ve(e,t,n,a,r,i,o,s,c,u,d,l,m,g,f){const{SharedFunctionalGroupsSequence:p,PerFrameFunctionalGroupsSequence:I,Rows:S,Columns:h}=r,O=p.PlaneOrientationSequence?p.PlaneOrientationSequence.ImageOrientationPatient:void 0,T=h*S;let D=0;const R=I.length,C=Math.ceil(R/10),E=f&&g;let y=!1;return new Promise(t=>{!function p(){for(let t=Math.min(D+C,R);D<t;++D){const t=I[D],g=O||t.PlaneOrientationSequence.ImageOrientationPatient,f=He(a,D*T,T),p=$e(Z()(f,[S,h]),g,o,c);if(!p)throw new Error("Individual SEG frames are out of plane with respect to the first SEG frame. This is not yet supported. Aborting segmentation loading.");const R=Le(r,D);if(void 0===R)throw new Error("Could not retrieve the segment index. Aborting segmentation loading.");d.has(R)||d.set(R,{});const C=qe(r,D,i,s,c,l);if(!C){console.warn("Image not present in stack, can't import frame : "+D+".");continue}const E=m.metadata[C];if(S!==E.Rows||h!==E.Columns)throw new Error("Individual SEG frames have different geometry dimensions (Rows and Columns) respect to the source image reference frame. This is not yet supported. Aborting segmentation loading. ");const N=m.indices[C],A=T*N*u.BYTES_PER_ELEMENT,M=new u(n[0],A,T),P=p.data,_=[];for(let t=0,n=p.data.length;t<n;++t)if(P[t]){for(let e=t;e<n;++e)P[e]&&(y||0===M[e]||(y=!0),M[e]=R,_.push(e));e[N]||(e[N]=[]),e[N].push(R);break}const v=d.get(R);v[N]=_,d.set(R,v)}if(E){const e=Math.round(D/R*100);f(g,Re.SEGMENTATION_LOAD_PROGRESS,{percentComplete:e})}D<R?setTimeout(p,0):t(y)}()})}function Be(e,t){const n=e.SegmentationType;let a;if(a=Array.isArray(e.PixelData)?e.PixelData[0]:e.PixelData,void 0===a&&u.Rm.error("This segmentation pixelData is undefined."),"BINARY"===n)return function(e,t){for(var n=new Uint8Array(e),a=[],r=8*t,i=Math.ceil(8*n.length/r),o=0;o<i;o++){var s=o*r,c=Math.min(s+r,8*n.length),u=Math.floor(s/8),d=Math.ceil(c/8),l=n.slice(u,d),m=Ae.unpack(l);a.push(m)}return a}(a,t.maxBytesPerChunk);if("LABELMAP"===n)return 8===e.BitsStored?new Uint8Array(a):16===e.BitsStored?new Uint16Array(a):new Uint8Array(a);const r=new Uint8Array(a),i=e.MaximumFractionalValue;return void 0===r.find(e=>0!==e&&e!==i)?(u.Rm.warn("This segmentation object is actually binary... processing as such."),r):void 0}function ke(e){return e&&e.NumberOfFrames>1}function je(e){const t=[];t[0]=e,t[1]=Ee.h(e),t[2]=Ee.v(e);const n=Ce(e,Math.PI/2);return t[3]=n,t[4]=Ee.h(n),t[5]=Ee.v(n),t[6]=Ce(e,Math.PI),t[7]=Ce(e,1.5*Math.PI),t}function $e(e,t,n,a){return m.utilities.isEqual(t,n[0],a)?e:m.utilities.isEqual(t,n[1],a)?ye.v(e):m.utilities.isEqual(t,n[2],a)?ye.h(e):m.utilities.isEqual(t,n[3],a)?Ne(e):m.utilities.isEqual(t,n[4],a)?Ne(ye.h(e)):m.utilities.isEqual(t,n[5],a)?Ne(ye.v(e)):m.utilities.isEqual(t,n[6],a)?Ne(Ne(e)):m.utilities.isEqual(t,n[7],a)?Ne(Ne(Ne(e))):void 0}function ze(e,t){const n=e.SegmentSequence;let a=[];return a=Array.isArray(n)?[void 0,...n]:[void 0,n],{seriesInstanceUid:t,data:a}}function He(e,t,n){const a=function(e,t,n){var a=e.reduce((e,t)=>e+t.length,0);if(t<0||t+n>a)throw new Error("Offset and length out of bounds");var r=0,i=t;for(;i>=e[r].length;)i-=e[r].length,r++;var o=r,s=i+n;for(;s>e[o].length;)s-=e[o].length,o++;return{start:{chunkIndex:r,offset:i},end:{chunkIndex:o,offset:s}}}(e,t,n);if(a.start.chunkIndex===a.end.chunkIndex)return new Uint8Array(e[a.start.chunkIndex].buffer,a.start.offset,n);{let t=new Uint8Array(n),r=0;for(let n=a.start.chunkIndex;n<=a.end.chunkIndex;n++){let i=n===a.start.chunkIndex?a.start.offset:0,o=n===a.end.chunkIndex?a.end.offset:e[n].length;t.set(new Uint8Array(e[n].buffer,i,o-i),r),r+=o-i}return t}}function Ye(e,t,n,a){let r=0,i=0,o=0,s=0,c=0,u=0,d=0;for(const[l,m]of Object.entries(e)){const e=Number(l);if(!m||0===m.length)continue;const g=a[e],f=n.get("imagePlaneModule",g);if(!f){console.debug("Missing imagePlaneModule metadata for centroid calculation");continue}const{imagePositionPatient:p,rowCosines:I,columnCosines:S,rowPixelSpacing:h,columnPixelSpacing:O}=f;for(const n of m){const a=Math.floor(n/t.Rows),l=n%t.Rows;r+=l,i+=a,o+=e;s+=p[0]+l*I[0]*O+a*S[0]*h,c+=p[1]+l*I[1]*O+a*S[1]*h,u+=p[2]+l*I[2]*O+a*S[2]*h,d++}}return{image:{x:Math.floor(r/d),y:Math.floor(i/d),z:Math.floor(o/d)},world:{x:s/d,y:c/d,z:u/d},count:d}}const We={generateSegmentation:function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return Ue(function(e,t,n){const a=ae(e,t);return new ve([a],n)}(e,ke(e[0]),n),t,n)},generateToolState:async function(e,t,n,a){const{skipOverlapping:r=!1,tolerance:i=.001,TypedArrayConstructor:o=Uint8Array,maxBytesPerChunk:s=199e6,eventTarget:c=null,triggerEvent:u=null}=a,d=Me.readFile(t),l=Pe.naturalizeDataset(d.dict);l._meta=Pe.namifyDataset(d.meta);const m=_e.normalizeToDataset([l]),g=n.get("imagePlaneModule",e[0]),f=n.get("generalSeriesModule",e[0]).seriesInstanceUID;g||console.warn("Insufficient metadata, imagePlaneModule missing.");const p=je(Array.isArray(g.rowCosines)?[...g.rowCosines,...g.columnCosines]:[g.rowCosines.x,g.rowCosines.y,g.rowCosines.z,g.columnCosines.x,g.columnCosines.y,g.columnCosines.z]),I=m.Columns*m.Rows,S=ze(m,f);let h,O;if("1.2.840.10008.1.2.5"===m._meta.TransferSyntaxUID.Value[0]){const e=Array.isArray(m.PixelData)?m.PixelData:[m.PixelData];if(h=we(e,m.Rows,m.Columns),1===m.BitsStored)return void console.warn("No implementation for rle + bitbacking.");O=[h]}else if(O=Be(m,{maxBytesPerChunk:s}),!O)throw new Error("Fractional segmentations are not yet supported");const T=De(m,p,[g.rows,g.columns,e.length],i),D=e.reduce((e,t)=>{const{sopInstanceUID:a}=n.get("generalImageModule",t);return e[a]=t,e},{});let R,C=!1;switch(r||(C=function(e,t,n,a,r,i,o,s){const{SharedFunctionalGroupsSequence:c,PerFrameFunctionalGroupsSequence:u,SegmentSequence:d,Rows:l,Columns:m}=t;if(d.length<2)return!1;const g=c.PlaneOrientationSequence?c.PlaneOrientationSequence.ImageOrientationPatient:void 0,f=m*l,p=u.length;let I=new Map;for(let e=0;e<p;++e){if(void 0===Le(t,e)){console.warn("Could not retrieve the segment index for frame segment "+e+", skipping this frame.");continue}const a=qe(t,e,n,r,i,s);if(!a){console.warn("Image not present in stack, can't import frame : "+e+".");continue}const o=n.findIndex(e=>e===a);if(I.has(o)){let t=I.get(o);t.includes(e)||(t.push(e),I.set(o,t))}else I.set(o,[e])}for(let[,t]of I.entries()){let n=new o(f).fill(0);for(let r=0;r<t.length;++r){const o=t[r],s=u[o],c=g||s.PlaneOrientationSequence.ImageOrientationPatient,d=He(e,o*f,f),p=$e(Z()(d,[l,m]),c,a,i);if(!p){console.warn("Individual SEG frames are out of plane with respect to the first SEG frame, this is not yet supported, skipping this frame.");continue}const I=p.data;for(let e=0,t=I.length;e<t;++e)if(0!==I[e]&&(n[e]++,n[e]>1))return!0}}return!1}(O,m,e,p,n,i,o,D)),T){case"Planar":R=C?Ge:Ve;break;case"Perpendicular":throw new Error("Segmentations orthogonal to the acquisition plane of the source data are not yet supported.");case"Oblique":throw new Error("Segmentations oblique to the acquisition plane of the source data are not yet supported.")}const E=[];E[0]=[];const y=[],N=I*e.length*o.BYTES_PER_ELEMENT,A=[];A[0]=new ArrayBuffer(N);const M=e.reduce((e,t,a)=>(e.indices[t]=a,e.metadata[t]=n.get("instance",t),e),{indices:{},metadata:{}}),P=new Map,_=await R(y,E,A,O,m,e,p,n,i,o,P,D,M,c,u),v=new Map;return P.forEach((t,a)=>{const r=Ye(t,m,n,e);v.set(a,r)}),{labelmapBufferArray:A,segMetadata:S,segmentsOnFrame:y,segmentsOnFrameArray:E,centroids:v,overlappingSegments:_}},fillSegmentation:Ue};function Ke(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{includeSliceSpacing:!0},a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:4;return 4===a?We.generateSegmentation(e,t,n):3===a?fe.generateSegmentation(e,t,n):void console.warn(`No generateSegmentation adapter for cornerstone version ${a}, exiting.`)}function Qe(e,t,n){let a=arguments.length>3&&void 0!==arguments[3]&&arguments[3],r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:.001,i=arguments.length>5&&void 0!==arguments[5]?arguments[5]:4;return 4===i?We.generateToolState(e,t,n,a,r):3===i?fe.generateToolState(e,t,n):void console.warn(`No generateToolState adapter for cornerstone version ${i}, exiting.`)}function Xe(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{includeSliceSpacing:!0},a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:4;if(4===a)return We.fillSegmentation(e,t,n);console.warn(`No generateSegmentation adapter for cornerstone version ${a}, exiting.`)}const{DicomMessage:Je,DicomMetaDictionary:Ze}=u.p,{Normalizer:et}=u.z8;function tt(e,t,n,a,r,i){let o;if(!e)return o;const{FrameOfReferenceUID:s,PerFrameFunctionalGroupsSequence:c,SourceImageSequence:u,ReferencedSeriesSequence:d}=e;if(!c||0===c.length)return o;const l=c[t];if(!l)return o;let g;if(l.DerivationImageSequence){let e=l.DerivationImageSequence;Array.isArray(e)&&(e=0!==e.length?e[0]:void 0),e&&(g=e.SourceImageSequence,Array.isArray(g)&&(g=0!==g.length?g[0]:void 0))}else u&&0!==u.length&&(console.warn("DerivationImageSequence not present, using SourceImageSequence assuming SEG has the same geometry as the source image."),g=u[t]);if(g&&(o=function(e,t){const{ReferencedSOPInstanceUID:n,ReferencedFrameNumber:a}=e;return a?function(e,t,n){const a=n[e];if(!a)return;const r=Number(a.split("frame=")[1]);return r===t-1?a:void 0}(n,a,t):t[n]}(g,i)),void 0===o&&d){o=function(e,t,n,a,r,i){if(void 0===e||void 0===n.PlanePositionSequence||void 0===n.PlanePositionSequence[0]||void 0===n.PlanePositionSequence[0].ImagePositionPatient)return;for(let o=0;o<a.length;++o){const s=r.get("instance",a[o]);if(void 0!==s&&void 0!==s.ImagePositionPatient&&s.FrameOfReferenceUID===t&&s.SeriesInstanceUID===e&&m.utilities.isEqual(n.PlanePositionSequence[0].ImagePositionPatient,s.ImagePositionPatient,i))return a[o]}}((Array.isArray(d)?d[0]:d).SeriesInstanceUID,s,l,n,a,r)}return o}const nt={generateToolState:async function(e,t,n){let a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:.001;const r=Je.readFile(t),i=Ze.naturalizeDataset(r.dict);i._meta=Ze.namifyDataset(r.meta);const o=et.normalizeToDataset([i]),s=n.get("imagePlaneModule",e[0]);s||console.warn("Insufficient metadata, imagePlaneModule missing.");const c=[Array.isArray(s.rowCosines)?[...s.rowCosines,...s.columnCosines]:[s.rowCosines.x,s.rowCosines.y,s.rowCosines.z,s.columnCosines.x,s.columnCosines.y,s.columnCosines.z]],d=function(e){let t,n;if(e.PixelData){t=(16===e.BitsAllocated?[Uint16Array,Int16Array]:[Uint32Array,Int32Array])[e.PixelRepresentation??0],n=e.PixelData}else e.FloatPixelData?(t=Float32Array,n=e.FloatPixelData):e.DoubleFloatPixelData&&(t=Float64Array,n=e.DoubleFloatPixelData);void 0===n&&u.Rm.error("This parametric map pixel data is undefined.");Array.isArray(n)&&(n=n[0]);return new t(n)}(o),l=De(o,c,[s.rows,s.columns,e.length],a),m=e.reduce((e,t)=>{const{sopInstanceUID:a}=n.get("generalImageModule",t);return e[a]=t,e},{});if("Planar"!==l){throw new Error(`Parametric maps ${{Perpendicular:"orthogonal",Oblique:"oblique"}[l]} to the acquisition plane of the source data are not yet supported.`)}const g=e.reduce((e,t,a)=>(e.indices[t]=a,e.metadata[t]=n.get("instance",t),e),{indices:{},metadata:{}});return await function(e,t,n,a,r,i,o){const s=new e.constructor(e.length),{PerFrameFunctionalGroupsSequence:c,Rows:u,Columns:d}=t,l=d*u,m=c.length;for(let c=0;c<m;c++){const m=new e.constructor(e.buffer,c*l,l),g=tt(t,c,n,a,r,i);if(!g){console.warn("Image not present in stack, can't import frame : "+c+".");continue}const f=o.metadata[g];if(u!==f.Rows||d!==f.Columns)throw new Error("Parametric map have different geometry dimensions (Rows and Columns) respect to the source image reference frame. This is not yet supported.");const p=l*o.indices[g]*s.BYTES_PER_ELEMENT;new s.constructor(s.buffer,p,l).set(m)}return s}(d,o,e,n,a,m,g),{pixelData:d}}},at={Length:M,FreehandRoi:_,Bidirectional:w,EllipticalRoi:F,CircleRoi:L,ArrowAnnotate:j,MeasurementReport:E,CobbAngle:H,Angle:K,RectangleRoi:X},rt={Segmentation:a},it={ParametricMap:nt};var ot="Cornerstone3DTools@^0.1.0";const st=["PatientName","PatientID","PatientBirthDate","PatientBirthTime","IssuerOfPatientID","OtherPatientIDs","OtherPatientIDsSequence","PatientSex","PatientIdentityRemoved","DeidentificationMethodCodeSequence","StudyDate","StudyTime","StudyStatusID","StudyPriorityID","StudyInstanceUID","StudyDescription","AccessionNumber","StudyID","ReferringPhysicianName","TimezoneOffsetFromUTC"];const ct=["SeriesInstanceUID","SeriesNumber","SeriesDescription","Modality","SeriesDate","SeriesTime","_meta","_vrMap"];function ut(e){const t={};for(const n of ct){const a=e[n];void 0!==a&&(t[n]=a)}return t}const{imageToWorldCoords:dt}=m.utilities;function lt(e,t){let{is3DMeasurement:n,referencedImageId:a}=e;const r=[];if(n){const{GraphicData:e}=t;for(let t=0;t<e.length;t+=3){const n=[e[t],e[t+1],e[t+2]];r.push(n)}}else{const{GraphicData:e}=t;for(let t=0;t<e.length;t+=2){const n=dt(a,[e[t],e[t+1]]);r.push(n)}}return r}const mt={CodingSchemeDesignator:"CORNERSTONEJS",codeValues:{CORNERSTONEFREETEXT:"CORNERSTONEFREETEXT"}},gt="none",ft={schemeDesignator:"99CS3D",meaning:"Text Annotation Position",value:"TextPosition"},pt={schemeDesignator:"DCM",meaning:"Comment",value:"121106"};new Uint8Array(2)[1]=1;const It=new Uint8Array(2);It[1]=2;new Uint8Array(2)[1]=1;const St={FileMetaInformationVersion:{Value:[It.buffer],vr:"OB"},TransferSyntaxUID:{Value:["1.2.840.10008.1.2"],vr:"UI"},ImplementationClassUID:{Value:["2.25.2470123695996825859949881583571202391.1.0.1"],vr:"UI"},ImplementationVersionName:{Value:["cs3d-4.8.4"],vr:"SH"}},ht={...St,ImplementationClassUID:{Value:["2.25.2470123695996825859949881583571202391.2.0.1"],vr:"UI"}},{worldToImageCoords:Ot}=m.utilities;let Tt=Ot;function Dt(e,t){let{is3DMeasurement:n,referencedImageId:a}=e;if(n)return{x:t[0],y:t[1],z:t[2]};const r=Tt(a,t);return{x:r[0],y:r[1]}}function Rt(e,t){return t.map(t=>Dt(e,t))}const{sr:{valueTypes:Ct,coding:Et}}=u.Ay;class yt{constructor(e,t){this.tid300Item=e,this.annotation=t,this.ReferencedSOPSequence=e.ReferencedSOPSequence}contentItem(){const e=this.tid300Item.contentItem(),{label:t,handles:n}=this.annotation.data;return t&&(e.push(this.createQualitativeLabel(t)),this.filterCornerstoneFreeText(e)),n?.textBox?.hasMoved&&e.push(this.createQualitativeLabelPosition(this.annotation)),e}filterCornerstoneFreeText(e){for(let t=0;t<e.length;t++){const n=e[t];if(!n.ConceptCodeSequence)continue;const a=n.ConceptCodeSequence.find(e=>"CORNERSTONEFREETEXT"===e.CodeValue);if(-1!==a)return n.ConceptCodeSequence.splice(a,1),void(0===n.ConceptCodeSequence.length&&e.splice(t,1))}}createQualitativeLabel(e){const t=Ct.RelationshipTypes.CONTAINS;return new Ct.TextContentItem({name:new Et.CodedConcept(pt),relationshipType:t,value:e})}createQualitativeLabelPosition(e){const{textBox:t}=e.data.handles,{referencedImageId:n,FrameOfReferenceUID:a}=e.metadata,r=!n,{worldPosition:i}=t,{x:o,y:s,z:c}=Dt({is3DMeasurement:r,referencedImageId:n},i),u=Ct.GraphicTypes.POINT,d=Ct.RelationshipTypes.CONTAINS,l=new Et.CodedConcept(ft);if(r){const e=[o,s,c];return new Ct.Scoord3DContentItem({name:l,relationshipType:d,graphicType:u,frameOfReferenceUID:a,graphicData:e})}const m=[o,s];return new Ct.ScoordContentItem({name:l,relationshipType:d,graphicType:u,graphicData:m})}}var Nt;const{MetadataModules:At}=m.Enums,{TID1500:Mt,addAccessors:Pt}=u.BF,{StructuredReport:_t}=u.h4,{Normalizer:vt}=u.z8,{TID1500MeasurementReport:xt,TID1501MeasurementGroup:wt}=Mt,{DicomMetaDictionary:bt}=u.p,Ut={CodingSchemeDesignator:"DCM",CodeValue:"121071"},Ft={CodingSchemeDesignator:pt.schemeDesignator,CodeValue:pt.value},qt={CodingSchemeDesignator:ft.schemeDesignator,CodeValue:ft.value},Gt={CodingSchemeDesignator:"SCT",CodeValue:"363698007"},Lt={CodingSchemeDesignator:"SRT",CodeValue:"G-C0E3"};class Vt{static getTID300ContentItem(e,t,n,a){const r=n.getTID300RepresentationArguments(e,a);r.ReferencedSOPSequence=t,r.use3DSpatialCoordinates&&(r.ReferencedFrameOfReferenceUID=e.metadata.FrameOfReferenceUID);const i=new n.TID300Representation(r);return new yt(i,e)}static getMeasurementGroup(e,t,n,a){const r=t[e],i=this.measurementAdapterByToolType.get(e);if(!(r&&r.data&&r.data.length&&i))return;const o=r.data.map(e=>this.getTID300ContentItem(e,n,i,a));return new wt(o)}static getCornerstoneLabelFromDefaultState(e){const{findingSites:t=[],finding:n,commentGroup:a}=e;if(a?.TextValue)return a.TextValue;const r=mt.codeValues.CORNERSTONEFREETEXT,i=t.find(e=>e.CodeValue===r);return i?i.CodeMeaning:n&&n.CodeValue===r?n.CodeMeaning:void 0}static generateDatasetMeta(){return St}static processSCOORDGroup(e){let{SCOORDGroup:t,toolType:n,sopInstanceUIDToImageIdMap:a,metadata:r}=e;const{ReferencedSOPSequence:i}=t.ContentSequence,{ReferencedSOPInstanceUID:o,ReferencedFrameNumber:s=1}=i,c=a[`${o}:${s}`],u=r.get("imagePlaneModule",c),d=bt.uid();return{SCOORDGroup:t,ReferencedSOPSequence:i,ReferencedSOPInstanceUID:o,ReferencedFrameNumber:s,referencedImageId:c,state:{description:void 0,sopInstanceUid:o,annotation:{data:{annotationUID:d,cachedStats:{},handles:{activeHandleIndex:0,textBox:{hasMoved:!1}}},annotationUID:d,metadata:{toolName:n,referencedImageId:c,FrameOfReferenceUID:u.frameOfReferenceUID}}}}}static processSCOORD3DGroup(e){let{SCOORD3DGroup:t,toolType:n}=e;const a=bt.uid(),r={SCOORD3DGroup:t,FrameOfReferenceUID:t.ReferencedFrameOfReferenceUID,state:{description:void 0,annotation:{annotationUID:a,data:{annotationUID:a,cachedStats:{},handles:{activeHandleIndex:0,textBox:{hasMoved:!1}}},metadata:{toolName:n,FrameOfReferenceUID:t.ReferencedFrameOfReferenceUID}}}};return m.utilities.updatePlaneRestriction(function(e){const t=[];if(!e?.length)return t;const{length:n}=e;if(n%3!=0)throw new Error(`Points array should be divisible by 3 for SCOORD3D, but contents are: ${JSON.stringify(e)} of length ${n}`);for(let a=0;a<n;a+=3)t.push([e[a],e[a+1],e[a+2]]);return t}(t.GraphicData),r.state.annotation.metadata),r}static getSpatialCoordinatesState(e){let{NUMGroup:t,sopInstanceUIDToImageIdMap:n,metadata:a,toolType:r}=e;const i=d(t.ContentSequence),o=i.find(e=>"SCOORD"===e.ValueType),s=i.find(e=>"SCOORD3D"===e.ValueType),c=s&&this.processSCOORD3DGroup({SCOORD3DGroup:s,toolType:r})||o&&this.processSCOORDGroup({SCOORDGroup:o,toolType:r,metadata:a,sopInstanceUIDToImageIdMap:n});if(!c)throw new Error("No spatial coordinates group found.");return c}static processSpatialCoordinatesGroup(e){let{NUMGroup:t,sopInstanceUIDToImageIdMap:n,metadata:a,findingGroup:r,findingSiteGroups:i,commentGroup:o,commentPositionGroup:s,toolType:c}=e;const{state:u,SCOORDGroup:d,ReferencedSOPSequence:l,ReferencedSOPInstanceUID:m,ReferencedFrameNumber:g,SCOORD3DGroup:f,FrameOfReferenceUID:p,referencedImageId:I,textBoxPosition:S}=this.getSpatialCoordinatesState({NUMGroup:t,sopInstanceUIDToImageIdMap:n,metadata:a,toolType:c}),h=r?Pt(r.ConceptCodeSequence):void 0,O=i.map(e=>Pt(e.ConceptCodeSequence));if(s){u.commentPositionGroup=s;const e=lt({is3DMeasurement:!I,referencedImageId:I},s);u.annotation.data.handles.textBox={hasMoved:!0,worldPosition:e[0]}}return u.finding=h,u.findingSites=O,u.commentGroup=o,u.commentPositionGroup=s,h&&(u.description=h.CodeMeaning),u.annotation.data.label=this.getCornerstoneLabelFromDefaultState(u),{defaultState:u,state:u,NUMGroup:t,scoord:f||d,SCOORDGroup:d,ReferencedSOPSequence:l,ReferencedSOPInstanceUID:m,referencedImageId:I,textBoxPosition:S,ReferencedFrameNumber:g,SCOORD3DGroup:f,FrameOfReferenceUID:p}}static getSetupMeasurementData(e,t,n,a){const{ContentSequence:r}=e,i=d(r),o=i.find(e=>this.codeValueMatch(e,Ut)),s=i.find(e=>this.codeValueMatch(e,Ft)),c=i.find(e=>this.codeValueMatch(e,qt)),u=i.filter(e=>this.codeValueMatch(e,Gt,Lt))||[],l=i.find(e=>"NUM"===e.ValueType)||{ContentSequence:i.filter(e=>"SCOORD"===e.ValueType||"SCOORD3D"===e.ValueType)},m=this.processSpatialCoordinatesGroup({NUMGroup:l,sopInstanceUIDToImageIdMap:t,metadata:n,findingGroup:o,findingSiteGroups:u,commentGroup:s,commentPositionGroup:c,toolType:a}),{referencedImageId:g}=m.state.annotation.metadata,f=!!m.SCOORD3DGroup,p={referencedImageId:g,is3DMeasurement:f},I=m.SCOORD3DGroup||m.SCOORDGroup,S=lt(p,I);return{...m,is3DMeasurement:f,scoordArgs:p,scoord:I,worldCoords:S}}static generateReferencedSOPSequence(e){let{toolData:t,toolTypes:n,metadataProvider:a,imageId:r,sopInstanceUIDsToSeriesInstanceUIDMap:i,derivationSourceDatasets:o}=e;const s=r===gt?this.getImageIdFromVolume({toolData:t,toolTypes:n}):r,c=a.get("sopCommonModule",s),u=a.get("instance",s),{sopInstanceUID:d,sopClassUID:l}=c,{SeriesInstanceUID:m}=u;if(i[d]=m,!o.find(e=>e.SeriesInstanceUID===m)){const e=Vt.generateDerivationSourceDataset(u);o.push(e)}const g=a.get("frameNumber",s),f={ReferencedSOPClassUID:l,ReferencedSOPInstanceUID:d,ReferencedFrameNumber:void 0};return(u&&u.NumberOfFrames&&u.NumberOfFrames>1||vt.isMultiframeSOPClassUID(l))&&(f.ReferencedFrameNumber=g),f}static getImageIdFromVolume(e){let{toolData:t,toolTypes:n}=e;const a=t?.[n?.[0]]?.data?.[0],r=a?.metadata?.volumeId,i=m.cache.getVolume(r);if(!i)throw new Error(`No volume found for ${r}`);return i.imageIds[0]}static generateReport(e,t,n){let a=[];const r={},i=[],o=Vt.generateDatasetMeta();let s=!1;Object.keys(e).forEach(n=>{const o=e[n],c=Object.keys(o),u=n===gt,d=this.generateReferencedSOPSequence({toolData:o,toolTypes:c,metadataProvider:t,imageId:n,sopInstanceUIDsToSeriesInstanceUIDMap:r,derivationSourceDatasets:i});u&&(s=!0);const l=[];c.forEach(e=>{const t=this.getMeasurementGroup(e,o,d,u);t&&l.push(t)}),a=a.concat(l)});const c=new xt({TID1501MeasurementGroups:a},n),u=new _t(i,n),d=c.contentItem(i,{...n,sopInstanceUIDsToSeriesInstanceUIDMap:r});if(u.dataset=Object.assign(u.dataset,d),u.dataset._meta=o,u.SpecificCharacterSet="ISO_IR 192",u.dataset.InstanceNumber||=n.InstanceNumber||1,n.predecessorImageId&&Object.assign(u.dataset,t.get(At.PREDECESSOR_SEQUENCE,n.predecessorImageId)),s&&(u.dataset.SOPClassUID=bt.sopClassUIDsByName.Comprehensive3DSR,!u.dataset.SOPClassUID))throw new Error(`NO sop class defined for Comprehensive3DSR in ${JSON.stringify(bt.sopClassUIDsByName)}`);return u}static generateToolState(e,t,n,a){if("1500"!==e.ContentTemplateSequence.TemplateIdentifier)throw new Error("This package can currently only interpret DICOM SR TID 1500");const{imageId:r}=e,i=d(e.ContentSequence).find(l("Imaging Measurements")),o=d(i.ContentSequence).filter(l("Measurement Group")),s={};return o.forEach(i=>{try{const o=d(i.ContentSequence),c=o.find(e=>"Tracking Identifier"===e.ConceptNameCodeSequence.CodeMeaning),{TextValue:u}=c,l=o.find(e=>"Tracking Unique Identifier"===e.ConceptNameCodeSequence.CodeMeaning),m=l?.UID,g=a?.getToolClass?.(i,e,this.measurementAdapterByToolType)||this.getAdapterForTrackingIdentifier(u)||this.getAdapterForCodeType(i);if(g){const e=g.getMeasurementData(i,t,n,u);e.TrackingUniqueIdentifier=m,e.predecessorImageId=r,console.log(`=== ${g.toolType} ===`),console.log(e),s[g.toolType]||=[],s[g.toolType].push(e)}}catch(e){console.warn("Unable to generate tool state for",i,e)}}),s}static registerTool(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const n=e.toolType;if(this.measurementAdapterByToolType.has(n)){if(!t)throw new Error(`The registered tool name ${n} already exists in adapters, use a different toolType or use replace`);"function"==typeof t&&t(this.measurementAdapterByToolType.get(n))}this.measurementAdapterByToolType.set(e.toolType,e),this.measurementAdapterByTrackingIdentifier.set(e.trackingIdentifierTextValue,e)}static registerTrackingIdentifier(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),a=1;a<t;a++)n[a-1]=arguments[a];for(const t of n)this.measurementAdapterByTrackingIdentifier.set(t,e)}static getAdapterForTrackingIdentifier(e){const t=this.measurementAdapterByTrackingIdentifier.get(e);if(t)return t;for(const t of[...this.measurementAdapterByToolType.values()])if(t.isValidCornerstoneTrackingIdentifier(e))return this.measurementAdapterByTrackingIdentifier.set(e,t),t}static getAdapterForCodeType(e){for(const t of this.measurementAdapterByTrackingIdentifier.values())if(t.isValidMeasurement(e))return t}static registerAdapterTypes(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),a=1;a<t;a++)n[a-1]=arguments[a];for(const t of n){this.measurementAdaptersByType.has(t)||this.measurementAdaptersByType.set(t,[]);const n=this.measurementAdaptersByType.get(t);-1===n.indexOf(e)&&n.push(e)}}static getAdaptersForTypes(e,t,n){const a=[];return Bt(a,this.measurementAdaptersByType.get(`${e}-${t}-${n}`)),Bt(a,this.measurementAdaptersByType.get(`${e}-${t}`)),Bt(a,this.measurementAdaptersByType.get(e)),Bt(a,this.measurementAdaptersByType.get(t)),a}}function Bt(e,t){t?.length&&e.push(...t)}(Nt=Vt).CORNERSTONE_3D_TAG=ot,Nt.measurementAdapterByToolType=new Map,Nt.measurementAdaptersByType=new Map,Nt.measurementAdapterByTrackingIdentifier=new Map,Nt.codeValueMatch=(e,t,n)=>{const{ConceptNameCodeSequence:a}=e;if(!a)return;const{CodingSchemeDesignator:r,CodeValue:i}=a;return r==t.CodingSchemeDesignator&&i==t.CodeValue||n&&r==n.CodingSchemeDesignator&&i==n.CodeValue},Nt.generateDerivationSourceDataset=e=>({...function(e){const t={_meta:e._meta,_vrMap:e._vrMap};for(const n of st){const a=e[n];void 0!==a&&(t[n]=a)}return t}(e),...ut(e)});class kt{static registerType(){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";e&&(n=`${n}${n.length?"-":""}${e}`),t&&(n=`${n}${n.length?"-":""}${t}`),Vt.registerAdapterTypes(this,n)}static getPointsCount(e){const t="SCOORD3D"===e.ValueType?3:2;return e.GraphicData.length/t}static getGraphicItems(e,t){const n=e.ContentSequence.filter(e=>"SCOORD"===e.ValueType||"SCOORD3D"===e.ValueType);return t?n.filter(t):n}static getGraphicItem(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;return this.getGraphicItems(e,n&&(e=>e.ValueType===n))[t]}static getGraphicCode(e){const{ConceptNameCodeSequence:t}=e,{CodeValue:n,CodingSchemeDesignator:a}=t;return`${a}:${n}`}static getGraphicType(e){return e.GraphicType}static isValidMeasurement(e){return!1}static init(e,t,n){if(this.toolType=e,kt.toolType)throw new Error(`Base adapter tool type set to ${this.toolType} while setting ${e}`);if(this.parentType=n?.parentType,this.trackingIdentifiers=new Set,this.TID300Representation=t,this.parentType){this.trackingIdentifierTextValue=`${ot}:${this.parentType}:${this.toolType}`;const e=`${ot}:${this.toolType}`;this.trackingIdentifiers.add(e)}else this.trackingIdentifierTextValue=`${ot}:${e}`;this.trackingIdentifiers.add(this.trackingIdentifierTextValue),Vt.registerTool(this)}static registerLegacy(){this.trackingIdentifiers.add(`cornerstoneTools@^4.0.0:${this.toolType}`)}static registerSubType(e,t,n){const a=Object.create(e);return a.init(t,e.TID300Representation,{parentType:e.parentType||e.toolType,replace:n}),a}static isValidCornerstoneTrackingIdentifier(e){return!!this.trackingIdentifiers.has(e)||!!e.includes(":")&&e.startsWith(this.trackingIdentifierTextValue)}static getMeasurementData(e,t,n,a){const{defaultState:r,ReferencedFrameNumber:i}=Vt.getSetupMeasurementData(e,t,n,this.toolType);return r.annotation.data={cachedStats:{},frameNumber:i,seriesLevel:a?.indexOf(":Series")>0},r}static getTID300RepresentationArguments(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const{metadata:n}=e,{finding:a,findingSites:r}=e,{referencedImageId:i}=n;return{points:Rt({is3DMeasurement:t,referencedImageId:i},e.data.handles.points),trackingIdentifierTextValue:this.trackingIdentifierTextValue,findingSites:r||[],finding:a,ReferencedFrameOfReferenceUID:t?n.FrameOfReferenceUID:null}}}var jt;const{Point:$t}=u.BF.TID300,{imageToWorldCoords:zt}=m.utilities;class Ht extends kt{static getMeasurementData(e,t,n,a){const{state:r,SCOORDGroup:i,worldCoords:o,referencedImageId:s,ReferencedFrameNumber:c}=Vt.getSetupMeasurementData(e,t,n,this.toolType),u=r.annotation.data.label;if(1===o.length&&i){const e=n.get("imagePixelModule",s);let t=10,a=10;if(e){const{columns:n,rows:r}=e;t=n/10,a=r/10}const{GraphicData:r}=i,c=zt(s,[r[0]+t,r[1]+a]);o.push(c)}return r.annotation.data={...r.annotation.data,text:u,handles:{...r.annotation.data.handles,arrowFirst:!0,points:o},frameNumber:c},r}static getTID300RepresentationArguments(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const{data:n,metadata:a,findingSites:r}=e,{finding:i}=e,{referencedImageId:o}=a,s={is3DMeasurement:t,referencedImageId:o},{points:c,arrowFirst:u}=n.handles,d=u?c[0]:c[1],l=u?c[1]:c[0];return{points:[Dt(s,d),Dt(s,l)],trackingIdentifierTextValue:this.trackingIdentifierTextValue,findingSites:r||[],finding:i,ReferencedFrameOfReferenceUID:t?a.FrameOfReferenceUID:null,use3DSpatialCoordinates:t}}}var Yt;(jt=Ht).init("ArrowAnnotate",$t),jt.registerLegacy();const{Bidirectional:Wt}=u.BF.TID300;class Kt extends kt{static getMeasurementData(e,t,n){const{state:a,scoordArgs:r,referencedImageId:i,ReferencedFrameNumber:o}=Vt.getSetupMeasurementData(e,t,n,this.toolType),{ContentSequence:s}=e,c=d(s).find(e=>"Long Axis"===e.ConceptNameCodeSequence.CodeMeaning),u=d(s).find(e=>"Short Axis"===e.ConceptNameCodeSequence.CodeMeaning),l=d(c.ContentSequence).find(e=>"SCOORD3D"===e.ValueType||"SCOORD"===e.ValueType),m=d(u.ContentSequence).find(e=>"SCOORD3D"===e.ValueType||"SCOORD"===e.ValueType),g=[];return g.push(...lt(r,l)),g.push(...lt(r,m)),a.annotation.data={...a.annotation.data,handles:{...a.annotation.data.handles,points:[g[0],g[1],g[2],g[3]]},frameNumber:o},i&&(a.annotation.data.cachedStats={[`imageId:${i}`]:{length:c.MeasuredValueSequence.NumericValue,width:u.MeasuredValueSequence.NumericValue}}),a}static getTID300RepresentationArguments(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const{data:n,finding:a,findingSites:r,metadata:i}=e,{cachedStats:o={},handles:s}=n,{referencedImageId:c}=i,u={is3DMeasurement:t,referencedImageId:c},{points:d}=s,l=[d[0],d[1]],m=[d[2],d[3]];let g,f;Math.sqrt(Math.pow(l[0][0]-l[1][0],2)+Math.pow(l[0][1]-l[1][1],2)+Math.pow(l[0][2]-l[1][2],2))>Math.sqrt(Math.pow(m[0][0]-m[1][0],2)+Math.pow(m[0][1]-m[1][1],2)+Math.pow(m[0][2]-m[1][2],2))?(g=l,f=m):(g=m,f=l);const p=Dt(u,g[0]),I=Dt(u,g[1]),S=Dt(u,f[0]),h=Dt(u,f[1]),{length:O,width:T}=o[`imageId:${c}`]||{};return{longAxis:{point1:p,point2:I},shortAxis:{point1:S,point2:h},longAxisLength:O,shortAxisLength:T,trackingIdentifierTextValue:this.trackingIdentifierTextValue,finding:a,findingSites:r||[],ReferencedFrameOfReferenceUID:t?i.FrameOfReferenceUID:null,use3DSpatialCoordinates:t}}}var Qt;(Yt=Kt).init("Bidirectional",Wt),Yt.registerLegacy();const{CobbAngle:Xt}=u.BF.TID300;class Jt extends kt{static getMeasurementData(e,t,n){const{state:a,NUMGroup:r,worldCoords:i,referencedImageId:o,ReferencedFrameNumber:s}=Vt.getSetupMeasurementData(e,t,n,this.toolType),c=o?{[`imageId:${o}`]:{angle:r?r.MeasuredValueSequence.NumericValue:null}}:{};return a.annotation.data={...a.annotation.data,handles:{...a.annotation.data.handles,points:[i[0],i[1],i[3]]},cachedStats:c,frameNumber:s},a}static getTID300RepresentationArguments(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const{data:n,finding:a,findingSites:r,metadata:i}=e,{cachedStats:o={},handles:s}=n,{referencedImageId:c}=i,u={is3DMeasurement:t,referencedImageId:c},d=Dt(u,s.points[0]),l=Dt(u,s.points[1]),m=Dt(u,s.points[1]),g=Dt(u,s.points[2]),f=o[`imageId:${c}`]?.angle;return{point1:d,point2:l,point3:m,point4:g,rAngle:f,trackingIdentifierTextValue:this.trackingIdentifierTextValue,finding:a,findingSites:r||[],ReferencedFrameOfReferenceUID:t?i.FrameOfReferenceUID:null,use3DSpatialCoordinates:t}}}var Zt;(Qt=Jt).init("Angle",Xt),Qt.registerLegacy();const{CobbAngle:en}=u.BF.TID300;class tn extends kt{static getMeasurementData(e,t,n){const{state:a,NUMGroup:r,referencedImageId:i,worldCoords:o,ReferencedFrameNumber:s}=Vt.getSetupMeasurementData(e,t,n,tn.toolType);return a.annotation.data={...a.annotation.data,handles:{...a.annotation.data.handles,points:[o[0],o[1],o[2],o[3]]},frameNumber:s},i&&(a.annotation.data.cachedStats={[`imageId:${i}`]:{angle:r?r.MeasuredValueSequence.NumericValue:null}}),a}static getTID300RepresentationArguments(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const{data:n,finding:a,findingSites:r,metadata:i}=e,{cachedStats:o={},handles:s}=n,{referencedImageId:c}=i,u=Rt({is3DMeasurement:t,referencedImageId:c},s.points),[d,l,m,g]=u,{angle:f}=o[`imageId:${c}`]||{};return{point1:d,point2:l,point3:m,point4:g,rAngle:f,trackingIdentifierTextValue:this.trackingIdentifierTextValue,finding:a,findingSites:r||[],ReferencedFrameOfReferenceUID:t?i.FrameOfReferenceUID:null,use3DSpatialCoordinates:t}}}var nn;(Zt=tn).init("CobbAngle",en),Zt.registerLegacy();const{Circle:an}=u.BF.TID300;class rn extends kt{static getMeasurementData(e,t,n){const{state:a,NUMGroup:r,worldCoords:i,referencedImageId:o,ReferencedFrameNumber:s}=Vt.getSetupMeasurementData(e,t,n,this.toolType);return a.annotation.data={...a.annotation.data,handles:{...a.annotation.data.handles,points:i},frameNumber:s},o&&(a.annotation.data.cachedStats={[`imageId:${o}`]:{area:r?r.MeasuredValueSequence.NumericValue:0,radius:0,perimeter:0}}),a}static getTID300RepresentationArguments(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const{data:n,finding:a,findingSites:r,metadata:i}=e,{cachedStats:o={},handles:s}=n,{referencedImageId:c}=i,u={is3DMeasurement:t,referencedImageId:c},d=Dt(u,s.points[0]),l=Dt(u,s.points[1]),{area:m,radius:g}=o[`imageId:${c}`]||{};return{area:m,perimeter:2*Math.PI*g,radius:g,points:[d,l],trackingIdentifierTextValue:this.trackingIdentifierTextValue,finding:a,findingSites:r||[],ReferencedFrameOfReferenceUID:t?i.FrameOfReferenceUID:null,use3DSpatialCoordinates:t}}}(nn=rn).init("CircleROI",an),nn.registerLegacy();const{Ellipse:on}=u.BF.TID300;class sn extends kt{static getMeasurementData(e,t,n){const{state:a,NUMGroup:r,worldCoords:i,referencedImageId:o,ReferencedFrameNumber:s}=Vt.getSetupMeasurementData(e,t,n,sn.toolType);return a.annotation.data={...a.annotation.data,handles:{...a.annotation.data.handles,points:i},frameNumber:s},a.annotation.data.cachedStats=o?{[`imageId:${o}`]:{area:r?r.MeasuredValueSequence.NumericValue:0}}:{},a}static getTID300RepresentationArguments(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const{data:n,finding:a,findingSites:r,metadata:i}=e,{cachedStats:o={},handles:s}=n,c=n.initialRotation||0,{referencedImageId:u}=i,d={is3DMeasurement:t,referencedImageId:u};let l,m,g,f;90==c||270==c?(m=s.points[2],l=s.points[3],g=s.points[0],f=s.points[1]):(l=s.points[0],m=s.points[1],g=s.points[2],f=s.points[3]);const p=[];Math.sqrt((l[0]-m[0])**2+(l[1]-m[1])**2+(l[2]-m[2])**2)>Math.sqrt((g[0]-f[0])**2+(g[1]-f[1])**2+(g[2]-f[2])**2)?p.push(l,m,g,f):p.push(g,f,l,m);const{area:I}=o[`imageId:${u}`]||{};return{area:I,points:p.map(e=>Dt(d,e)),trackingIdentifierTextValue:this.trackingIdentifierTextValue,finding:a,findingSites:r||[],ReferencedFrameOfReferenceUID:t?i.FrameOfReferenceUID:null,use3DSpatialCoordinates:t}}}var cn;sn.init("EllipticalROI",on);const{Polyline:un}=u.BF.TID300;class dn extends kt{static isValidMeasurement(e){const t=this.getGraphicItem(e),n=this.getPointsCount(t);return"POLYLINE"===this.getGraphicType(t)&&(4===n||5===n)}static getMeasurementData(e,t,n){const{state:a,worldCoords:r,referencedImageId:i,ReferencedFrameNumber:o}=Vt.getSetupMeasurementData(e,t,n,this.toolType),s=5===r.length?r.slice(0,4):r,c=e.ContentSequence.find(e=>"NUM"===e.ValueType&&"Area"===e.ConceptNameCodeSequence[0].CodeMeaning),u=i?{[`imageId:${i}`]:{area:c?.MeasuredValueSequence?.[0]?.NumericValue||0,areaUnit:c?.MeasuredValueSequence?.[0]?.MeasurementUnitsCodeSequence?.CodeValue}}:{};return a.annotation.data={...a.annotation.data,handles:{...a.annotation.data.handles,points:[s[0],s[1],s[3],s[2]]},cachedStats:u,frameNumber:o},a}static getTID300RepresentationArguments(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const{data:n,finding:a,findingSites:r,metadata:i}=e,{referencedImageId:o}=i,s=Rt({is3DMeasurement:t,referencedImageId:o},n.handles.points),{area:c,perimeter:u}=n.cachedStats[`imageId:${o}`]||{};return{points:[s[0],s[1],s[3],s[2],s[0]],area:c,perimeter:u,trackingIdentifierTextValue:this.trackingIdentifierTextValue,finding:a,findingSites:r||[],use3DSpatialCoordinates:t}}}var ln;(cn=dn).init("RectangleROI",un),cn.registerLegacy(),cn.registerType("DCM:111030","POLYLINE",4),cn.registerType("DCM:111030","POLYLINE",5);const{Length:mn}=u.BF.TID300;class gn extends kt{static getMeasurementData(e,t,n){const{state:a,NUMGroup:r,worldCoords:i,referencedImageId:o,ReferencedFrameNumber:s}=Vt.getSetupMeasurementData(e,t,n,this.toolType),c=o?{[`imageId:${o}`]:{length:r?r.MeasuredValueSequence.NumericValue:0}}:{};return a.annotation.data={...a.annotation.data,handles:{...a.annotation.data.handles,points:[i[0],i[1]],activeHandleIndex:0},cachedStats:c,frameNumber:s},a}static getTID300RepresentationArguments(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const{data:n,finding:a,findingSites:r,metadata:i}=e,{cachedStats:o={},handles:s}=n,{referencedImageId:c}=i,u={is3DMeasurement:t,referencedImageId:c},d=Dt(u,s.points[0]),l=Dt(u,s.points[1]),{length:m}=o[`imageId:${c}`]||{};return{point1:d,point2:l,distance:m,trackingIdentifierTextValue:this.trackingIdentifierTextValue,finding:a,findingSites:r||[],use3DSpatialCoordinates:t}}}(ln=gn).init("Length",mn),ln.registerLegacy();var fn,pn=n(3823);const{Polyline:In}=u.BF.TID300;class Sn extends kt{static getMeasurementData(e,t,n){const{state:a,NUMGroup:r,worldCoords:i,referencedImageId:o,ReferencedFrameNumber:s}=Vt.getSetupMeasurementData(e,t,n,this.toolType);let c=!0;pn.eR.distance(i[i.length-1],i[0])<this.closedContourThreshold&&(i.pop(),c=!1);const u=[];return c&&u.push(i[0],i[i.length-1]),a.annotation.data={...a.annotation.data,contour:{polyline:i,closed:!c},handles:{...a.annotation.data.handles,points:u},frameNumber:s},o&&(a.annotation.data.cachedStats={[`imageId:${o}`]:{area:r?r.MeasuredValueSequence.NumericValue:null}}),a}static getTID300RepresentationArguments(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const{data:n,finding:a,findingSites:r,metadata:i}=e,{polyline:o,closed:s}=n.contour,c=!0!==s,{referencedImageId:u}=i,d=Rt({is3DMeasurement:t,referencedImageId:u},o);if(!c){const e=d[0];d.push(e)}const{area:l,areaUnit:m,modalityUnit:g,perimeter:f,mean:p,max:I,stdDev:S}=n.cachedStats[`imageId:${u}`]||{};return{points:d,area:l,areaUnit:m,perimeter:f,modalityUnit:g,mean:p,max:I,stdDev:S,trackingIdentifierTextValue:this.trackingIdentifierTextValue,finding:a,findingSites:r||[],ReferencedFrameOfReferenceUID:t?i.FrameOfReferenceUID:null,use3DSpatialCoordinates:t}}}var hn;(fn=Sn).closedContourThreshold=1e-5,fn.init("PlanarFreehandROI",In);const{Point:On}=u.BF.TID300;class Tn extends kt{static isValidMeasurement(e){const t=this.getGraphicItem(e);return"POINT"===this.getGraphicType(t)&&this.getPointsCount(t)<=2}static getMeasurementData(e,t,n,a){const{state:r,NUMGroup:i,worldCoords:o,referencedImageId:s,ReferencedFrameNumber:c}=Vt.getSetupMeasurementData(e,t,n,this.toolType),u=s?{[`imageId:${s}`]:{value:i?.MeasuredValueSequence?.NumericValue??null}}:{};return r.annotation.data={...r.annotation.data,handles:{...r.annotation.data.handles,points:o},cachedStats:u,frameNumber:c,invalidated:!0},r}static getTID300RepresentationArguments(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const{data:n,metadata:a}=e,{finding:r,findingSites:i}=e,{referencedImageId:o}=a,s={is3DMeasurement:t,referencedImageId:o},{handles:{points:c=[]}}=n;return{points:Rt(s,c),trackingIdentifierTextValue:this.trackingIdentifierTextValue,findingSites:i||[],finding:r,ReferencedFrameOfReferenceUID:t?a.FrameOfReferenceUID:null,use3DSpatialCoordinates:t}}}(hn=Tn).init("Probe",On),hn.registerLegacy(),hn.registerType("DCM:111030","POINT",1),hn.registerType("DCM:111030","POINT",2);const{Length:Dn}=u.BF.TID300,{worldToImageCoords:Rn}=m.utilities;class Cn extends kt{static getMeasurementData(e,t,n){const{state:a,worldCoords:r,ReferencedFrameNumber:i}=Vt.getSetupMeasurementData(e,t,n,this.toolType);return a.annotation.data={...a.annotation.data,handles:{...a.annotation.data.handles,points:r},frameNumber:i},a}static getTID300RepresentationArguments(e,t){const{data:n,finding:a,findingSites:r,metadata:i}=e,{handles:o}=n,{referencedImageId:s}=i;if(!s)throw new Error("UltrasoundDirectionalTool.getTID300RepresentationArguments: referencedImageId is not defined");const c=Rn(s,o.points[0]),u=Rn(s,o.points[1]);return{point1:{x:c[0],y:c[1]},point2:{x:u[0],y:u[1]},trackingIdentifierTextValue:this.trackingIdentifierTextValue,finding:a,findingSites:r||[]}}}Cn.init("UltrasoundDirectionalTool",Dn);const{MetadataModules:En}=m.Enums,{SEGImageNormalizer:yn}=u.z8,{Segmentation:Nn}=u.h4;function An(e,t,n){let a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};const r=function(e,t,n){const a=n?.predecessorImageId||e[0].imageId,r=t.get(En.STUDY_DATA,a),i=e.map(e=>{const{imageId:n}=e,a=t.get(En.SERIES_DATA,n),i=t.get(En.IMAGE_DATA,n);return{...r,...a,...i,PixelData:e.voxelManager.getScalarData(),BitsAllocated:16,_vrMap:{PixelData:"OW"},_meta:{}}}),o=1===i.length&&!(i[0].NumberOfFrames>1);o&&i.push(i[0]);const s=new yn(i);s.normalize();const{dataset:c}=s;if(!c)throw new Error("Failed to normalize the multiframe dataset, the data is not multi-frame.");c.SharedFunctionalGroupsSequence||={},c.SharedFunctionalGroupsSequence.PixelMeasuresSequence={},c.PerFrameFunctionalGroupsSequence||=[];for(let t=0;t<e.length;t++)c.PerFrameFunctionalGroupsSequence[t]||={PlanePositionSequence:{},PlaneOrientationSequence:{}};o&&(c.PerFrameFunctionalGroupsSequence=[c.PerFrameFunctionalGroupsSequence[0]],c.NumberOfFrames=1);return new Nn([c],n)}(e,n,a),i=Ue(r,t,a),o=a?.predecessorImageId;if(o){const e=n.get(En.PREDECESSOR_SEQUENCE,o);Object.assign(i,e)}return i}function Mn(e){const{scalarData:t,dimensions:n}=e,a=[],r=new Set;for(let e=0;e<n[2];e++){const i=t.slice(e*n[0]*n[1],(e+1)*n[0]*n[1]),o=[];for(let e=0;e<i.length;e++){const t=i[e];o.includes(t)||0===t||o.push(t)}const s={segmentsOnLabelmap:o,pixelData:i,rows:n[1],columns:n[0]};0!==o.length&&(o.forEach(e=>{r.add(e)}),a[n[2]-1-e]=s)}return e.segmentsOnLabelmap=Array.from(r),e.labelmaps2D=a,e}var Pn=n(4667);const _n=e=>{let{largerArray:t,currentTestedArray:n,newArray:a}=e;return t.some((e,t)=>{const r=n[t],i=a[t];return!(!r||!i)&&r.some((e,t)=>{const n=i[t];return e&&n})})},vn=e=>{let{arrayOfSegmentData:t,newSegmentData:n}=e;if(0!==t.length){for(let e=0;e<t.length;e++){const a=t[e],r=a.length>n.length?a:n;if(!_n({currentTestedArray:a,largerArray:r,newArray:n}))return void r.forEach((e,t)=>{const r=a[t],i=n[t];if(!r&&!i||!i)return;if(!r)return void(a[t]=i);const o=r.map((e,t)=>{const n=i[t];return e||n});a[t]=o})}t.push(n)}else t.push(n)},{DicomMessage:xn,DicomMetaDictionary:wn}=u.p,{Normalizer:bn}=u.z8,{decode:Un}=u.BF.compression,Fn=e=>{let{segmentsOnFrame:t,imageIdIndex:n,segmentIndex:a}=e;t[n]||(t[n]=[]),t[n].push(a)},qn=e=>{let{segmentsPixelIndices:t,segmentIndex:n,imageIdIndex:a,indexCache:r}=e;t.has(n)||t.set(n,{});const i=t.get(n);i[a]=r,t.set(n,i)},Gn=e=>{let{PerFrameFunctionalGroups:t,sequenceIndex:n,sopUIDImageIdIndexMap:a,multiframe:r}=e;const i=t.DerivationImageSequence[0].SourceImageSequence[0].ReferencedSOPInstanceUID;return{referencedSOPInstanceUid:i,referencedImageId:a[i],segmentIndex:Le(r,n)}};const Ln=Pn.utilities.throttle(e=>{(0,m.triggerEvent)(m.eventTarget,Re.SEGMENTATION_LOAD_PROGRESS,{percentComplete:e})},200);function Vn(e){let{segmentsOnFrame:t,labelMapImages:n,pixelDataChunks:a,multiframe:r,referencedImageIds:i,validOrientations:o,metadataProvider:s,tolerance:c,segmentsPixelIndices:u,sopUIDImageIdIndexMap:d,imageIdMaps:l}=e;const{SharedFunctionalGroupsSequence:m,PerFrameFunctionalGroupsSequence:g,Rows:f,Columns:p}=r,I=m.PlaneOrientationSequence?m.PlaneOrientationSequence.ImageOrientationPatient:void 0,S=p*f,h=g.length;let O=!1;return new Promise(e=>{const m=Math.ceil(.1*h),T=D=>{for(let T=D;T<D+m&&T<h;T++){const m=g[T],h=I||m.PlaneOrientationSequence.ImageOrientationPatient,D=He(a,T*S,S),R=$e(Z()(D,[f,p]),h,o,c);if(!R)throw new Error("Individual SEG frames are out of plane with respect to the first SEG frame. This is not yet supported. Aborting segmentation loading.");const C=Le(r,T);if(void 0===C)throw new Error("Could not retrieve the segment index. Aborting segmentation loading.");u.has(C)||u.set(C,{});const E=qe(r,T,i,s,c,d);if(!E)return void console.warn("Image not present in stack, can't import frame : "+T+".");const y=l.metadata[E];if(f!==y.Rows||p!==y.Columns)throw new Error("Individual SEG frames have different geometry dimensions (Rows and Columns) respect to the source image reference frame. This is not yet supported. Aborting segmentation loading. ");const N=l.indices[E],A=n[N],M=A.getPixelData(),P=A.voxelManager,_=R.data,v=[];for(let m=0,g=R.data.length;m<g;++m)if(_[m]){for(let f=m;f<g;++f)if(_[f]){if(!O&&0!==M[f])return O=!0,e($n({segmentsOnFrame:t,labelMapImages:n,pixelDataChunks:a,multiframe:r,referencedImageIds:i,validOrientations:o,metadataProvider:s,tolerance:c,segmentsPixelIndices:u,sopUIDImageIdIndexMap:d,imageIdMaps:l}));P?P.setAtIndex(f,C):M[f]=C,v.push(f)}t[N]||(t[N]=[]),t[N].push(C);break}const x=u.get(C);x[N]=v,u.set(C,x)}const R=Math.round(D/h*100);Ln(R),D<h?setTimeout(()=>T(D+m),0):e({hasOverlappingSegments:!1,arrayOfLabelMapImages:[n]})},D=g=>{const I=r.PerFrameFunctionalGroupsSequence,O=r.SharedFunctionalGroupsSequence.PlaneOrientationSequence?.ImageOrientationPatient;for(let e=g;e<g+m&&e<h;e++){const m=I[e],g=O||m.PlaneOrientationSequence.ImageOrientationPatient,h=a.subarray(e*S,(e+1)*S),T=$e(Z()(h,[f,p]),g,o,c);if(!T)throw new Error("Individual Labelmap SEG frames are out of plane with respect to the first SEG frame. This is not yet supported. Aborting segmentation loading.");const D=qe(r,e,i,s,c,d);if(!D){console.warn(`Image not present in stack, can't import frame : ${e}.`);continue}const R=l.metadata[D];if(f!==R.Rows||p!==R.Columns)throw new Error("Individual Labelmap SEG frames have different geometry dimensions (Rows and Columns) respect to the source image reference frame. This is not yet supported. Aborting segmentation loading. ");const C=l.indices[D],E=n[C].getPixelData(),y=T.data;let N=t[C];N||(N=[],t[C]=N);const A=new Set(N);for(let e=0,t=y.length;e<t;++e){const t=y[e];if(0!==t){E[e]=t,A.has(t)||(N.push(t),A.add(t)),u.has(t)||u.set(t,{});const n=u.get(t);n[C]||(n[C]=[]),n[C].push(e)}}}const T=Math.round(g/h*100);Ln(T),g<h?setTimeout(()=>D(g+m),0):e({hasOverlappingSegments:!1,arrayOfLabelMapImages:[n]})};"LABELMAP"===r.SegmentationType?D(0):T(0)})}const Bn=e=>{let{sharedImageOrientationPatient:t,PerFrameFunctionalGroups:n,pixelDataChunks:a,sequenceIndex:r,sliceLength:i,Rows:o,Columns:s,validOrientations:c,tolerance:u}=e;const d=t||n.PlaneOrientationSequence.ImageOrientationPatient,l=He(a,r*i,i),m=$e(Z()(l,[o,s]),d,c,u);if(!m)throw new Error("Individual SEG frames are out of plane with respect to the first SEG frame. This is not yet supported. Aborting segmentation loading.");return m},kn=e=>{let{metadataProvider:t,imageId:n,Rows:a,Columns:r}=e;const i=t.get("instance",n);if(a!==i.Rows||r!==i.Columns)throw new Error("Individual SEG frames have different geometry dimensions (Rows and Columns) respect to the source image reference frame. This is not yet supported. Aborting segmentation loading. ")},jn=e=>{let{arrayOfSegmentData:t,referencedImageIds:n}=e,a=[];for(let e=0;e<t.length;e++){const n=t[e];n.length>a.length&&(a=n)}return t.map(e=>n.map((t,n)=>{const a=!e[n],r=m.imageLoader.createAndCacheDerivedLabelmapImage(t),i=r.getPixelData();if(!a)for(let t=0;t<i.length;t++)i[t]=e[n][t];return r}).filter(Boolean))};function $n(e){let{segmentsOnFrame:t,labelMapImages:n,pixelDataChunks:a,multiframe:r,referencedImageIds:i,validOrientations:o,metadataProvider:s,tolerance:c,segmentsPixelIndices:u,sopUIDImageIdIndexMap:d,imageIdMaps:l}=e;const{SharedFunctionalGroupsSequence:m,PerFrameFunctionalGroupsSequence:g,Rows:f,Columns:p}=r,I=m.PlaneOrientationSequence?m.PlaneOrientationSequence.ImageOrientationPatient:void 0,S=zn({sliceLength:p*f,Rows:f,Columns:p,validOrientations:o,metadataProvider:s,imageIdMaps:l,segmentsOnFrame:t,tolerance:c,pixelDataChunks:a,PerFrameFunctionalGroupsSequence:g,labelMapImages:n,sopUIDImageIdIndexMap:d,multiframe:r,sharedImageOrientationPatient:I,segmentsPixelIndices:u});return{arrayOfLabelMapImages:jn({arrayOfSegmentData:S,referencedImageIds:i}),hasOverlappingSegments:!0}}const zn=e=>{let{sliceLength:t,Rows:n,Columns:a,validOrientations:r,metadataProvider:i,imageIdMaps:o,segmentsOnFrame:s,tolerance:c,pixelDataChunks:u,PerFrameFunctionalGroupsSequence:d,labelMapImages:l,sopUIDImageIdIndexMap:m,multiframe:g,sharedImageOrientationPatient:f,segmentsPixelIndices:p}=e;const I=[],S=g.SegmentSequence.length;for(let e=1;e<=S;++e){const S=Hn({PerFrameFunctionalGroupsSequence:d,labelMapImages:l,sopUIDImageIdIndexMap:m,multiframe:g,segmentIndex:e,sliceLength:t,Rows:n,Columns:a,validOrientations:r,tolerance:c,pixelDataChunks:u,sharedImageOrientationPatient:f,metadataProvider:i,imageIdMaps:o,segmentsOnFrame:s,segmentsPixelIndices:p});vn({arrayOfSegmentData:I,newSegmentData:S})}return I},Hn=e=>{let{PerFrameFunctionalGroupsSequence:t,labelMapImages:n,sopUIDImageIdIndexMap:a,multiframe:r,segmentIndex:i,sliceLength:o,Rows:s,Columns:c,validOrientations:u,tolerance:d,pixelDataChunks:l,sharedImageOrientationPatient:m,metadataProvider:g,imageIdMaps:f,segmentsOnFrame:p,segmentsPixelIndices:I}=e;const S=[];for(let e=0;e<n.length;e++){const h=n[e],O=h.referencedImageId,T=t.findIndex((e,t)=>{const{segmentIndex:n,referencedImageId:o}=Gn({PerFrameFunctionalGroups:e,sequenceIndex:t,sopUIDImageIdIndexMap:a,multiframe:r});return n===i&&o===h.referencedImageId});if(-1===T)continue;const D=t[T],R=Bn({sharedImageOrientationPatient:m,PerFrameFunctionalGroups:D,pixelDataChunks:l,sequenceIndex:T,sliceLength:o,Rows:s,Columns:c,validOrientations:u,tolerance:d});kn({metadataProvider:g,Rows:s,Columns:c,imageId:O});const C=[],E=R.data.map((e,t)=>((e?i:0)&&C.push(t),e?i:0));C.length>0&&(S[e]=E);const y=f.indices[O];Fn({imageIdIndex:y,segmentIndex:i,segmentsOnFrame:p}),qn({imageIdIndex:y,segmentIndex:i,segmentsPixelIndices:I,indexCache:C})}return S};function Yn(e,t,n){return Qe(e,t,n,arguments.length>3&&void 0!==arguments[3]&&arguments[3],arguments.length>4&&void 0!==arguments[4]?arguments[4]:.001,arguments.length>5&&void 0!==arguments[5]?arguments[5]:4)}function Wn(e,t,n){let{metadataProvider:a,tolerance:r=.001}=n;return async function(e,t,n,a){const{tolerance:r=.001,TypedArrayConstructor:i=Uint8Array,maxBytesPerChunk:o=199e6}=a,s=xn.readFile(t),c=wn.naturalizeDataset(s.dict);c._meta=wn.namifyDataset(s.meta);const u=bn.normalizeToDataset([c]),d=n.get("imagePlaneModule",e[0]),l=n.get("generalSeriesModule",e[0]).seriesInstanceUID;d||console.warn("Insufficient metadata, imagePlaneModule missing.");const g=je(Array.isArray(d.rowCosines)?[...d.rowCosines,...d.columnCosines]:[d.rowCosines.x,d.rowCosines.y,d.rowCosines.z,d.columnCosines.x,d.columnCosines.y,d.columnCosines.z]),f=ze(u,l);let p,I;if("1.2.840.10008.1.2.5"===u._meta.TransferSyntaxUID.Value[0]){const e=Array.isArray(u.PixelData)?u.PixelData:[u.PixelData];if(p=Un(e,u.Rows,u.Columns),1===u.BitsStored)return void console.warn("No implementation for rle + bit packing.");I=[p]}else if(I=Be(u,{maxBytesPerChunk:o}),!I)throw new Error("Fractional segmentations are not yet supported");const S=De(u,g,[d.rows,d.columns,e.length],r),h=e.reduce((e,t)=>{const{sopInstanceUID:a}=n.get("generalImageModule",t);return e[a]=t,e},{});let O;switch(S){case"Planar":O=Vn;break;case"Perpendicular":throw new Error("Segmentations orthogonal to the acquisition plane of the source data are not yet supported.");case"Oblique":throw new Error("Segmentations oblique to the acquisition plane of the source data are not yet supported.")}const T=[],D={indices:{},metadata:{}},R=[];for(let t=0;t<e.length;t++){const a=e[t];D.indices[a]=t,D.metadata[a]=n.get("instance",a);const r=m.imageLoader.createAndCacheDerivedLabelmapImage(a);R.push(r)}const C=new Map,{hasOverlappingSegments:E,arrayOfLabelMapImages:y}=await O({segmentsOnFrame:T,labelMapImages:R,pixelDataChunks:I,multiframe:u,referencedImageIds:e,validOrientations:g,metadataProvider:n,tolerance:r,segmentsPixelIndices:C,sopUIDImageIdIndexMap:h,imageIdMaps:D,TypedArrayConstructor:i}),N=new Map;return C.forEach((t,a)=>{const r=Ye(t,u,n,e);N.set(a,r)}),{labelMapImages:y,segMetadata:f,segmentsOnFrame:T,centroids:N,overlappingSegments:E}}(e,t,a,{tolerance:r})}const{ParametricMap:Kn}=it,{generateToolState:Qn}=Kn;function Xn(e,t,n){return Qn(e,t,n,arguments.length>3&&void 0!==arguments[3]&&arguments[3],arguments.length>4&&void 0!==arguments[4]?arguments[4]:.001)}function Jn(e,t,n){const{FrameOfReferenceUID:a}=t;e||=[];let r=e.find(e=>e.FrameOfReferenceUID===a);return r||(r={FrameOfReferenceUID:a},e.push(r)),e}const{MetadataModules:Zn}=m.Enums;function ea(e,t,n){const a=n?.metadataProvider||m.metaData,{referencedImageId:r}=t,i=a.get(Zn.REFERENCED_SERIES_REFERENCE,r);if(e||=[],i){const{ReferencedSeriesInstanceUID:t,ReferencedInstanceSequence:[{ReferencedSOPInstanceUID:n}]}=i,a=e.find(e=>e.ReferencedSeriesInstanceUID===t);if(!a)return e.push(i),e;if(a.ReferencedInstanceSequence.find(e=>e.ReferencedSOPInstanceUID===n))return e;const r=i.ReferencedInstanceSequence;a.ReferencedInstanceSequence.push(Array.isArray(r)?r[0]:r)}return e}function ta(e,t,n){return{ObservationNumber:t+1,ReferencedROINumber:e.segmentIndex??t+1,RTROIInterpretedType:n?.interpretedType||"ORGAN",ROIInterpreter:n?.observerName||""}}function na(e,t){const{FrameOfReferenceUID:n}=e.metadata;return{ROINumber:t.segmentIndex,ROIName:t.label,ROIDescription:t.label,ROIGenerationAlgorithm:"MANUAL",ReferencedFrameOfReferenceUID:n}}const{DicomMetaDictionary:aa}=u.Ay.data,{MetadataModules:ra}=m.Enums,ia=[ra.GENERAL_STUDY,ra.PATIENT_STUDY,ra.PATIENT],oa=[ra.GENERAL_SERIES],sa=[ra.GENERAL_IMAGE,ra.IMAGE_PLANE,ra.CINE,ra.VOI_LUT,ra.MODALITY_LUT,ra.SOP_COMMON],ca={get:function(e,t,n){return ca[e]?.(t,n)},[ra.IMAGE_SOP_INSTANCE_REFERENCE]:function(e){const t=m.metaData.get(ra.FRAME_MODULE,e),{sopClassUID:n,sopInstanceUID:a,frameNumber:r,numberOfFrames:i}=t;return i>1?{ReferencedSOPClassUID:n,ReferencedSOPInstanceUID:a,ReferencedFrameNumber:r}:{ReferencedSOPClassUID:t.sopClassUID,ReferencedSOPInstanceUID:t.sopInstanceUID}},[ra.REFERENCED_SERIES_REFERENCE]:e=>{const t=m.metaData.get(ra.SOP_COMMON,e);return{SeriesInstanceUID:m.metaData.get(ra.GENERAL_SERIES,e).seriesInstanceUID,ReferencedInstanceSequence:[{ReferencedSOPClassUID:t.sopClassUID,ReferencedSOPInstanceUID:t.sopInstanceUID}]}},[ra.PREDECESSOR_SEQUENCE]:e=>{const t={...m.metaData.get(ra.SERIES_DATA,e)},n=m.metaData.get(ra.GENERAL_IMAGE,e),a=m.metaData.get(ra.GENERAL_STUDY,e);return t.InstanceNumber=1+Number(n.instanceNumber),t.PredecessorDocumentsSequence={StudyInstanceUID:a.studyInstanceUID,ReferencedSeriesSequence:{SeriesInstanceUID:t.SeriesInstanceUID,ReferencedSOPSequence:{ReferencedSOPClassUID:n.sopClassUID,ReferencedSOPInstanceUID:n.sopInstanceUID}}},t},[ra.STUDY_DATA]:e=>m.metaData.getNormalized(e,ia),[ra.SERIES_DATA]:e=>m.metaData.getNormalized(e,oa),[ra.IMAGE_DATA]:e=>m.metaData.getNormalized(e,sa),[ra.RTSS_INSTANCE_DATA]:e=>({...m.metaData.get(ra.NEW_INSTANCE_DATA,e),SeriesNumber:"3201",StructureSetROISequence:[],ROIContourSequence:[],RTROIObservationsSequence:[],ReferencedFrameOfReferenceSequence:[],Modality:"RTSTRUCT",SOPClassUID:"1.2.840.10008.5.1.4.1.1.481.3",PositionReferenceIndicator:"",StructureSetLabel:"",StructureSetName:"",StructureSetDate:aa.date(),StructureSetTime:aa.time()}),[ra.NEW_INSTANCE_DATA]:e=>({...m.metaData.get(ra.STUDY_DATA,e),SeriesNumber:"50000",InstanceNumber:"1",OperatorsName:"",ReferringPhysicianName:"",SpecificCharacterSet:"ISO_IR 192",Manufacturer:"cs3d",SOPInstanceUID:aa.uid(),SeriesInstanceUID:aa.uid()}),[ra.RTSS_CONTOUR]:()=>ht,[ra.SR_ANNOTATION]:()=>St};m.metaData.addProvider(ca.get,9023);const{MetadataModules:ua}=m.Enums;function da(e,t,n){if(t)for(const[a,r]of Object.entries(t))void 0!==r&&(void 0===e[a]&&n?.requireDestinationKey||(e[a]=r))}const{generateContourSetsFromLabelmap:la,AnnotationToPointData:ma}=Pn.utilities.contours,{MetadataModules:ga}=m.Enums;function fa(e,t,n){return pa(e,{metadataProvider:t,_DicomMetadataStore:n})}async function pa(e,t){const{metadataProvider:n=m.metaData}=t,a=[];(await la({segmentations:e})).forEach((e,t)=>{if(e){const r=[];e.sliceContours.forEach(e=>{const t=n.get("ImageSopInstanceReference",e.referencedImageId),{points:a}=e.polyData;e.contours.forEach((e,n)=>{const i=e.type,o=e.contourPoints.length,s=[];e.contourPoints.forEach(e=>{const t=a[e];s.push(...t.map(e=>e.toFixed(2)))}),r.push({ContourImageSequence:t,ContourGeometricType:i,NumberOfContourPoints:o,ContourNumber:n+1,ContourData:s})})});const i=e.label||`Segment ${t+1}`,o={name:i,description:i,contourSequence:r,color:e.color.slice(0,3),metadata:e.metadata};a.push(o)}});const r=Sa(e,a[0].metadata,t);return a.forEach((n,a)=>{const i={ROIDisplayColor:n.color||[255,0,0],ContourSequence:n.contourSequence,ReferencedROINumber:a+1},o=e.segments[a+1];r.StructureSetROISequence.push(na(n,o)),r.RTROIObservationsSequence.push(ta(o,a,t)),r.ROIContourSequence.push(i),r.ReferencedSeriesSequence=ea(r.ReferencedSeriesSequence,n.metadata,t),r.ReferencedFrameOfReferenceSequence=Jn(r.ReferencedFrameOfReferenceSequence,n.metadata)}),1===r.ReferencedFrameOfReferenceSequence?.length&&(r.FrameOfReferenceUID=r.ReferencedFrameOfReferenceSequence[0].FrameOfReferenceUID),r}function Ia(e,t,n){const a=Sa(e,t[0].metadata,n),r=new Map;return t.forEach((t,i)=>{const{data:{segmentation:o}}=t;if(!o)return void console.warn("Annotation is not a segmentation:",t);const{segmentationId:s,segmentIndex:c}=o,u=`${s}:${c}`;let d=r.get(u);if(!d){const s=e.segments[c],l=na(t,s);a.StructureSetROISequence.push(l),a.RTROIObservationsSequence.push(ta(s,i,n)),d={...o,annotations:[],structureSetModule:l,segment:s,roiContourSequence:null},r.set(u,d)}const l=ma.convert(t,d.segment,m.metaData);d.roiContourSequence?d.roiContourSequence.ContourSequence.push(...l.ContourSequence):(a.ROIContourSequence.push(l),d.roiContourSequence=l),a.ReferencedSeriesSequence=ea(a.ReferencedSeriesSequence,t.metadata,n),a.ReferencedFrameOfReferenceSequence=Jn(a.ReferencedFrameOfReferenceSequence,t.metadata)}),1===a.ReferencedFrameOfReferenceSequence?.length&&(a.FrameOfReferenceUID=a.ReferencedFrameOfReferenceSequence[0].FrameOfReferenceUID),a}function Sa(e,t,n){const{referencedImageId:a}=t;return function(e,t,n,a){const{metadataProvider:r=m.metaData,predecessorImageId:i}=a,o={},s=r.get(e,t);if(Object.assign(o,s),da(o,n),da(o,a,{requireDestinationKey:!0}),i){const e=r.get(ua.PREDECESSOR_SEQUENCE,i);Object.assign(o,e)}return o}(ga.RTSS_INSTANCE_DATA,a,{StructureSetLabel:e.label,StructureSetName:e.label,SeriesDescription:e.label,_meta:m.metaData.get(ga.RTSS_CONTOUR,a)},n)}function ha(e,t){const{annotationUIDsMap:n}=e.representationData.Contour,a=[];for(const e of n.values())for(const t of e.values()){const e=Pn.annotation.state.getAnnotation(t);e?a.push(e):console.error("Unable to find an annotation for UID",t)}return Ia(e,a,t)}function Oa(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(e.representationData.Labelmap)return pa(e,t);if(e.representationData.Contour)return ha(e,t);throw new Error(`No representation available to save to RTSS: ${Object.keys(e.representationData)}`)}const{generateContourSetsFromLabelmap:Ta}=Pn.utilities.contours;var Da;const{Point:Ra}=u.BF.TID300;class Ca extends Tn{static getMeasurementData(e,t,n,a){const r=super.getMeasurementData(e,t,n,a),{data:i}=r.annotation;return i.isPoint=-1!==a.indexOf("Point"),r}static getTID300RepresentationArguments(e){const t=super.getTID300RepresentationArguments(e),{data:n}=e;return n.isPoint&&(n.seriesLevel?t.trackingIdentifierTextValue=this.trackingSeriesPointIdentifier:t.trackingIdentifierTextValue=this.trackingPointIdentifier),n.seriesLevel&&(t.trackingIdentifierTextValue=this.trackingSeriesIdentifier),t.points.length||t.points.push({x:0,y:0}),t}}(Da=Ca).init("KeyImage",Ra,{parentType:Tn.toolType}),Da.trackingSeriesIdentifier=`${Da.trackingIdentifierTextValue}:Series`,Da.trackingPointIdentifier=`${Da.trackingIdentifierTextValue}:Point`,Da.trackingSeriesPointIdentifier=`${Da.trackingIdentifierTextValue}:SeriesPoint`;const Ea={BaseAdapter3D:kt,Bidirectional:Kt,CobbAngle:tn,Angle:Jt,Length:gn,CircleROI:rn,EllipticalROI:sn,RectangleROI:dn,ArrowAnnotate:Ht,Probe:Tn,PlanarFreehandROI:Sn,UltrasoundDirectional:Cn,KeyImage:Ca,MeasurementReport:Vt,CodeScheme:mt,CORNERSTONE_3D_TAG:ot,COMMENT_CODE:pt,NO_IMAGE_ID:gt,TEXT_ANNOTATION_POSITION:ft},ya={Segmentation:r},Na={ParametricMap:i},Aa={RTSS:o},{Colors:Ma,BitArray:Pa}=u.p;function _a(e){const t=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:3;switch(t){case 1:return Math.abs(e);case 2:return Math.sqrt(e[0]*e[0]+e[1]*e[1]);case 3:return Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]);default:{let n=0;for(let a=0;a<t;a++)n+=e[a]*e[a];return Math.sqrt(n)}}}(e);return 0!==t&&(e[0]/=t,e[1]/=t,e[2]/=t),t}const va={Cornerstone:at,Cornerstone3D:Ea},xa={Cornerstone:rt,Cornerstone3D:ya,VTKjs:{Segmentation:class{constructor(){}static generateSegments(e){"Array"!==e.SegmentSequence.constructor.name&&(e.SegmentSequence=[e.SegmentSequence]),e.SegmentSequence.forEach(e=>{const t=function(e){const t=Ma.dicomlab2RGB(e).map(e=>Math.round(255*e));return t.push(255),t}(e.RecommendedDisplayCIELabValue);segments[e.SegmentNumber]={color:t,functionalGroups:[],offset:null,size:null,pixelData:null}}),e.PerFrameFunctionalGroupsSequence.forEach(e=>{const t=e.SegmentIdentificationSequence.ReferencedSegmentNumber;segments[t].functionalGroups.push(e)});const t=Math.ceil(e.Rows*e.Columns/8);let n=0;return Object.keys(segments).forEach(a=>{const r=segments[a];r.numberOfFrames=r.functionalGroups.length,r.size=r.numberOfFrames*t,r.offset=n,n=r.offset+r.size;const i=e.PixelData.slice(r.offset,n);r.pixelData=Pa.unpack(i);const o=function(e,t){const n={},a=e.SharedFunctionalGroupsSequence.PixelMeasuresSequence,r=e.SharedFunctionalGroupsSequence.PlaneOrientationSequence,i=t[0],o=t[t.length-1],s=i.PlanePositionSequence.ImagePositionPatient.map(Number),c=o.PlanePositionSequence.ImagePositionPatient.map(Number);n.origin=s,n.spacing=[a.PixelSpacing[1],a.PixelSpacing[0],a.SpacingBetweenSlices].map(Number),n.dimensions=[e.Columns,e.Rows,t.length].map(Number);const u=r.ImageOrientationPatient.map(Number),d=u.slice(0,3),l=u.slice(3,6);var m,g,f;return n.planeNormal=[],function(e,t,n){const a=e[1]*t[2]-e[2]*t[1],r=e[2]*t[0]-e[0]*t[2],i=e[0]*t[1]-e[1]*t[0];n[0]=a,n[1]=r,n[2]=i}(d,l,n.planeNormal),n.sliceStep=[],m=c,g=s,(f=n.sliceStep)[0]=m[0]-g[0],f[1]=m[1]-g[1],f[2]=m[2]-g[2],_a(n.sliceStep),n.direction=d.concat(l).concat(n.sliceStep),n}(e,r.functionalGroups);r.geometry=o}),segments}}}},wa={Cornerstone:it,Cornerstone3D:Na},ba={Cornerstone3D:Aa},{datasetToBlob:Ua}=u.p;function Fa(e,t){let n;if(e instanceof ArrayBuffer)n=new Blob([e],{type:"application/dicom"});else{if(!e._meta)throw new Error("Dataset must have a _meta property");n=Ua(e)}const a=document.createElement("a");a.href=window.URL.createObjectURL(n),a.download=t,a.click(),URL.revokeObjectURL(a.href)}},75183:(e,t,n)=>{"use strict";var a;n.d(t,{A:()=>r}),function(e){e.Interaction="Interaction",e.HandlesUpdated="HandlesUpdated",e.StatsUpdated="StatsUpdated",e.InitialSetup="InitialSetup",e.Completed="Completed",e.InterpolationUpdated="InterpolationUpdated",e.History="History",e.MetadataReferenceModified="MetadataReferenceModified",e.LabelChange="LabelChange"}(a||(a={}));const r=a},94021:(e,t,n)=>{"use strict";var a;n.d(t,{A:()=>r}),function(e){e.TOOL_ACTIVATED="CORNERSTONE_TOOLS_TOOL_ACTIVATED",e.TOOLGROUP_VIEWPORT_ADDED="CORNERSTONE_TOOLS_TOOLGROUP_VIEWPORT_ADDED",e.TOOLGROUP_VIEWPORT_REMOVED="CORNERSTONE_TOOLS_TOOLGROUP_VIEWPORT_REMOVED",e.TOOL_MODE_CHANGED="CORNERSTONE_TOOLS_TOOL_MODE_CHANGED",e.CROSSHAIR_TOOL_CENTER_CHANGED="CORNERSTONE_TOOLS_CROSSHAIR_TOOL_CENTER_CHANGED",e.VOLUMECROPPINGCONTROL_TOOL_CHANGED="CORNERSTONE_TOOLS_VOLUMECROPPINGCONTROL_TOOL_CHANGED",e.VOLUMECROPPING_TOOL_CHANGED="CORNERSTONE_TOOLS_VOLUMECROPPING_TOOL_CHANGED",e.STACK_PREFETCH_COMPLETE="CORNERSTONE_TOOLS_STACK_PREFETCH_COMPLETE",e.ANNOTATION_ADDED="CORNERSTONE_TOOLS_ANNOTATION_ADDED",e.ANNOTATION_COMPLETED="CORNERSTONE_TOOLS_ANNOTATION_COMPLETED",e.ANNOTATION_MODIFIED="CORNERSTONE_TOOLS_ANNOTATION_MODIFIED",e.ANNOTATION_REMOVED="CORNERSTONE_TOOLS_ANNOTATION_REMOVED",e.ANNOTATION_SELECTION_CHANGE="CORNERSTONE_TOOLS_ANNOTATION_SELECTION_CHANGE",e.ANNOTATION_LOCK_CHANGE="CORNERSTONE_TOOLS_ANNOTATION_LOCK_CHANGE",e.ANNOTATION_VISIBILITY_CHANGE="CORNERSTONE_TOOLS_ANNOTATION_VISIBILITY_CHANGE",e.ANNOTATION_RENDERED="CORNERSTONE_TOOLS_ANNOTATION_RENDERED",e.ANNOTATION_CUT_MERGE_PROCESS_COMPLETED="CORNERSTONE_TOOLS_ANNOTATION_CUT_MERGE_PROCESS_COMPLETED",e.ANNOTATION_INTERPOLATION_PROCESS_COMPLETED="CORNERSTONE_TOOLS_ANNOTATION_INTERPOLATION_PROCESS_COMPLETED",e.INTERPOLATED_ANNOTATIONS_REMOVED="CORNERSTONE_TOOLS_INTERPOLATED_ANNOTATIONS_REMOVED",e.SEGMENTATION_MODIFIED="CORNERSTONE_TOOLS_SEGMENTATION_MODIFIED",e.SEGMENTATION_RENDERED="CORNERSTONE_TOOLS_SEGMENTATION_RENDERED",e.SEGMENTATION_REPRESENTATION_ADDED="CORNERSTONE_TOOLS_SEGMENTATION_REPRESENTATION_ADDED",e.SEGMENTATION_ADDED="CORNERSTONE_TOOLS_SEGMENTATION_ADDED",e.SEGMENTATION_REPRESENTATION_MODIFIED="CORNERSTONE_TOOLS_SEGMENTATION_REPRESENTATION_MODIFIED",e.SEGMENTATION_REMOVED="CORNERSTONE_TOOLS_SEGMENTATION_REMOVED",e.SEGMENTATION_REPRESENTATION_REMOVED="CORNERSTONE_TOOLS_SEGMENTATION_REPRESENTATION_REMOVED",e.SEGMENTATION_DATA_MODIFIED="CORNERSTONE_TOOLS_SEGMENTATION_DATA_MODIFIED",e.HISTORY_UNDO="CORNERSTONE_TOOLS_HISTORY_UNDO",e.HISTORY_REDO="CORNERSTONE_TOOLS_HISTORY_REDO",e.KEY_DOWN="CORNERSTONE_TOOLS_KEY_DOWN",e.KEY_UP="CORNERSTONE_TOOLS_KEY_UP",e.MOUSE_DOWN="CORNERSTONE_TOOLS_MOUSE_DOWN",e.MOUSE_UP="CORNERSTONE_TOOLS_MOUSE_UP",e.MOUSE_DOWN_ACTIVATE="CORNERSTONE_TOOLS_MOUSE_DOWN_ACTIVATE",e.MOUSE_DRAG="CORNERSTONE_TOOLS_MOUSE_DRAG",e.MOUSE_MOVE="CORNERSTONE_TOOLS_MOUSE_MOVE",e.MOUSE_CLICK="CORNERSTONE_TOOLS_MOUSE_CLICK",e.MOUSE_DOUBLE_CLICK="CORNERSTONE_TOOLS_MOUSE_DOUBLE_CLICK",e.MOUSE_WHEEL="CORNERSTONE_TOOLS_MOUSE_WHEEL",e.TOUCH_START="CORNERSTONE_TOOLS_TOUCH_START",e.TOUCH_START_ACTIVATE="CORNERSTONE_TOOLS_TOUCH_START_ACTIVATE",e.TOUCH_PRESS="CORNERSTONE_TOOLS_TOUCH_PRESS",e.TOUCH_DRAG="CORNERSTONE_TOOLS_TOUCH_DRAG",e.TOUCH_END="CORNERSTONE_TOOLS_TOUCH_END",e.TOUCH_TAP="CORNERSTONE_TOOLS_TAP",e.TOUCH_SWIPE="CORNERSTONE_TOOLS_SWIPE"}(a||(a={}));const r=a},18682:(e,t,n)=>{"use strict";var a;n.d(t,{A:()=>r}),function(e){e.Labelmap="Labelmap",e.Contour="Contour",e.Surface="Surface"}(a||(a={}));const r=a},84093:(e,t,n)=>{"use strict";var a;n.d(t,{A:()=>r}),function(e){e.OnInteractionStart="onInteractionStart",e.OnInteractionEnd="onInteractionEnd",e.Preview="preview",e.RejectPreview="rejectPreview",e.AcceptPreview="acceptPreview",e.Fill="fill",e.Interpolate="interpolate",e.StrategyFunction="strategyFunction",e.CreateIsInThreshold="createIsInThreshold",e.Initialize="initialize",e.INTERNAL_setValue="setValue",e.AddPreview="addPreview",e.ComputeInnerCircleRadius="computeInnerCircleRadius",e.GetStatistics="getStatistics",e.EnsureImageVolumeFor3DManipulation="ensureImageVolumeFor3DManipulation",e.EnsureSegmentationVolumeFor3DManipulation="ensureSegmentationVolumeFor3DManipulation"}(a||(a={}));const r=a},66452:(e,t,n)=>{"use strict";var a,r;n.d(t,{i:()=>a,q:()=>r}),function(e){e[e.Primary=1]="Primary",e[e.Secondary=2]="Secondary",e[e.Primary_And_Secondary=3]="Primary_And_Secondary",e[e.Auxiliary=4]="Auxiliary",e[e.Primary_And_Auxiliary=5]="Primary_And_Auxiliary",e[e.Secondary_And_Auxiliary=6]="Secondary_And_Auxiliary",e[e.Primary_And_Secondary_And_Auxiliary=7]="Primary_And_Secondary_And_Auxiliary",e[e.Fourth_Button=8]="Fourth_Button",e[e.Fifth_Button=16]="Fifth_Button",e[e.Wheel=524288]="Wheel",e[e.Wheel_Primary=524289]="Wheel_Primary"}(a||(a={})),function(e){e[e.Shift=16]="Shift",e[e.Ctrl=17]="Ctrl",e[e.Alt=18]="Alt",e[e.Meta=91]="Meta",e[e.ShiftCtrl=1617]="ShiftCtrl",e[e.ShiftAlt=1618]="ShiftAlt",e[e.ShiftMeta=1691]="ShiftMeta",e[e.CtrlAlt=1718]="CtrlAlt",e[e.CtrlMeta=1791]="CtrlMeta",e[e.AltMeta=1891]="AltMeta"}(r||(r={}))},49892:(e,t,n)=>{"use strict";var a;n.d(t,{A:()=>r}),function(e){e.Active="Active",e.Passive="Passive",e.Enabled="Enabled",e.Disabled="Disabled"}(a||(a={}));const r=a},10401:(e,t,n)=>{"use strict";var a;n.d(t,{H:()=>a}),function(e){e.UP="UP",e.DOWN="DOWN",e.LEFT="LEFT",e.RIGHT="RIGHT"}(a||(a={}))},99737:(e,t,n)=>{"use strict";n.r(t),n.d(t,{AnnotationStyleStates:()=>o,ChangeTypes:()=>m.A,Events:()=>c.A,KeyboardBindings:()=>r.q,MouseBindings:()=>r.i,SegmentationRepresentations:()=>u.A,StrategyCallbacks:()=>l.A,Swipe:()=>d.H,ToolModes:()=>i.A,WorkerTypes:()=>g});var a,r=n(66452),i=n(49892);!function(e){e.Default="",e.Highlighted="Highlighted",e.Selected="Selected",e.Locked="Locked",e.AutoGenerated="AutoGenerated"}(a||(a={}));const o=a;var s,c=n(94021),u=n(18682),d=n(10401),l=n(84093),m=n(75183);!function(e){e.POLYSEG_CONTOUR_TO_LABELMAP="Converting Contour to Labelmap",e.POLYSEG_SURFACE_TO_LABELMAP="Converting Surfaces to Labelmap",e.POLYSEG_CONTOUR_TO_SURFACE="Converting Contour to Surface",e.POLYSEG_LABELMAP_TO_SURFACE="Converting Labelmap to Surface",e.SURFACE_CLIPPING="Clipping Surfaces",e.COMPUTE_STATISTICS="Computing Statistics",e.INTERPOLATE_LABELMAP="Interpolating Labelmap",e.COMPUTE_LARGEST_BIDIRECTIONAL="Computing Largest Bidirectional",e.GENERATE_CONTOUR_SETS="Generating Contour Sets"}(s||(s={}));const g=s},26337:e=>{"use strict";e.exports=function(e){for(var t=new Array(e),n=0;n<e;++n)t[n]=n;return t}},11604:e=>{e.exports=function(e){return null!=e&&null!=e.constructor&&"function"==typeof e.constructor.isBuffer&&e.constructor.isBuffer(e)}},3293:(e,t,n)=>{var a=n(26337),r=n(11604),i="undefined"!=typeof Float64Array;function o(e,t){return e[0]-t[0]}function s(){var e,t=this.stride,n=new Array(t.length);for(e=0;e<n.length;++e)n[e]=[Math.abs(t[e]),e];n.sort(o);var a=new Array(n.length);for(e=0;e<a.length;++e)a[e]=n[e][1];return a}function c(e,t){var n=["View",t,"d",e].join("");t<0&&(n="View_Nil"+e);var r="generic"===e;if(-1===t){var i="function "+n+"(a){this.data=a;};var proto="+n+".prototype;proto.dtype='"+e+"';proto.index=function(){return -1};proto.size=0;proto.dimension=-1;proto.shape=proto.stride=proto.order=[];proto.lo=proto.hi=proto.transpose=proto.step=function(){return new "+n+"(this.data);};proto.get=proto.set=function(){};proto.pick=function(){return null};return function construct_"+n+"(a){return new "+n+"(a);}";return new Function(i)()}if(0===t){i="function "+n+"(a,d) {this.data = a;this.offset = d};var proto="+n+".prototype;proto.dtype='"+e+"';proto.index=function(){return this.offset};proto.dimension=0;proto.size=1;proto.shape=proto.stride=proto.order=[];proto.lo=proto.hi=proto.transpose=proto.step=function "+n+"_copy() {return new "+n+"(this.data,this.offset)};proto.pick=function "+n+"_pick(){return TrivialArray(this.data);};proto.valueOf=proto.get=function "+n+"_get(){return "+(r?"this.data.get(this.offset)":"this.data[this.offset]")+"};proto.set=function "+n+"_set(v){return "+(r?"this.data.set(this.offset,v)":"this.data[this.offset]=v")+"};return function construct_"+n+"(a,b,c,d){return new "+n+"(a,d)}";return new Function("TrivialArray",i)(u[e][0])}i=["'use strict'"];var o=a(t),c=o.map(function(e){return"i"+e}),d="this.offset+"+o.map(function(e){return"this.stride["+e+"]*i"+e}).join("+"),l=o.map(function(e){return"b"+e}).join(","),m=o.map(function(e){return"c"+e}).join(",");i.push("function "+n+"(a,"+l+","+m+",d){this.data=a","this.shape=["+l+"]","this.stride=["+m+"]","this.offset=d|0}","var proto="+n+".prototype","proto.dtype='"+e+"'","proto.dimension="+t),i.push("Object.defineProperty(proto,'size',{get:function "+n+"_size(){return "+o.map(function(e){return"this.shape["+e+"]"}).join("*"),"}})"),1===t?i.push("proto.order=[0]"):(i.push("Object.defineProperty(proto,'order',{get:"),t<4?(i.push("function "+n+"_order(){"),2===t?i.push("return (Math.abs(this.stride[0])>Math.abs(this.stride[1]))?[1,0]:[0,1]}})"):3===t&&i.push("var s0=Math.abs(this.stride[0]),s1=Math.abs(this.stride[1]),s2=Math.abs(this.stride[2]);if(s0>s1){if(s1>s2){return [2,1,0];}else if(s0>s2){return [1,2,0];}else{return [1,0,2];}}else if(s0>s2){return [2,0,1];}else if(s2>s1){return [0,1,2];}else{return [0,2,1];}}})")):i.push("ORDER})")),i.push("proto.set=function "+n+"_set("+c.join(",")+",v){"),r?i.push("return this.data.set("+d+",v)}"):i.push("return this.data["+d+"]=v}"),i.push("proto.get=function "+n+"_get("+c.join(",")+"){"),r?i.push("return this.data.get("+d+")}"):i.push("return this.data["+d+"]}"),i.push("proto.index=function "+n+"_index(",c.join(),"){return "+d+"}"),i.push("proto.hi=function "+n+"_hi("+c.join(",")+"){return new "+n+"(this.data,"+o.map(function(e){return["(typeof i",e,"!=='number'||i",e,"<0)?this.shape[",e,"]:i",e,"|0"].join("")}).join(",")+","+o.map(function(e){return"this.stride["+e+"]"}).join(",")+",this.offset)}");var g=o.map(function(e){return"a"+e+"=this.shape["+e+"]"}),f=o.map(function(e){return"c"+e+"=this.stride["+e+"]"});i.push("proto.lo=function "+n+"_lo("+c.join(",")+"){var b=this.offset,d=0,"+g.join(",")+","+f.join(","));for(var p=0;p<t;++p)i.push("if(typeof i"+p+"==='number'&&i"+p+">=0){d=i"+p+"|0;b+=c"+p+"*d;a"+p+"-=d}");i.push("return new "+n+"(this.data,"+o.map(function(e){return"a"+e}).join(",")+","+o.map(function(e){return"c"+e}).join(",")+",b)}"),i.push("proto.step=function "+n+"_step("+c.join(",")+"){var "+o.map(function(e){return"a"+e+"=this.shape["+e+"]"}).join(",")+","+o.map(function(e){return"b"+e+"=this.stride["+e+"]"}).join(",")+",c=this.offset,d=0,ceil=Math.ceil");for(p=0;p<t;++p)i.push("if(typeof i"+p+"==='number'){d=i"+p+"|0;if(d<0){c+=b"+p+"*(a"+p+"-1);a"+p+"=ceil(-a"+p+"/d)}else{a"+p+"=ceil(a"+p+"/d)}b"+p+"*=d}");i.push("return new "+n+"(this.data,"+o.map(function(e){return"a"+e}).join(",")+","+o.map(function(e){return"b"+e}).join(",")+",c)}");var I=new Array(t),S=new Array(t);for(p=0;p<t;++p)I[p]="a[i"+p+"]",S[p]="b[i"+p+"]";i.push("proto.transpose=function "+n+"_transpose("+c+"){"+c.map(function(e,t){return e+"=("+e+"===undefined?"+t+":"+e+"|0)"}).join(";"),"var a=this.shape,b=this.stride;return new "+n+"(this.data,"+I.join(",")+","+S.join(",")+",this.offset)}"),i.push("proto.pick=function "+n+"_pick("+c+"){var a=[],b=[],c=this.offset");for(p=0;p<t;++p)i.push("if(typeof i"+p+"==='number'&&i"+p+">=0){c=(c+this.stride["+p+"]*i"+p+")|0}else{a.push(this.shape["+p+"]);b.push(this.stride["+p+"])}");return i.push("var ctor=CTOR_LIST[a.length+1];return ctor(this.data,a,b,c)}"),i.push("return function construct_"+n+"(data,shape,stride,offset){return new "+n+"(data,"+o.map(function(e){return"shape["+e+"]"}).join(",")+","+o.map(function(e){return"stride["+e+"]"}).join(",")+",offset)}"),new Function("CTOR_LIST","ORDER",i.join("\n"))(u[e],s)}var u={float32:[],float64:[],int8:[],int16:[],int32:[],uint8:[],uint16:[],uint32:[],array:[],uint8_clamped:[],bigint64:[],biguint64:[],buffer:[],generic:[]};e.exports=function(e,t,n,a){if(void 0===e)return(0,u.array[0])([]);"number"==typeof e&&(e=[e]),void 0===t&&(t=[e.length]);var o=t.length;if(void 0===n){n=new Array(o);for(var s=o-1,d=1;s>=0;--s)n[s]=d,d*=t[s]}if(void 0===a){a=0;for(s=0;s<o;++s)n[s]<0&&(a-=(t[s]-1)*n[s])}for(var l=function(e){if(r(e))return"buffer";if(i)switch(Object.prototype.toString.call(e)){case"[object Float64Array]":return"float64";case"[object Float32Array]":return"float32";case"[object Int8Array]":return"int8";case"[object Int16Array]":return"int16";case"[object Int32Array]":return"int32";case"[object Uint8Array]":return"uint8";case"[object Uint16Array]":return"uint16";case"[object Uint32Array]":return"uint32";case"[object Uint8ClampedArray]":return"uint8_clamped";case"[object BigInt64Array]":return"bigint64";case"[object BigUint64Array]":return"biguint64"}return Array.isArray(e)?"array":"generic"}(e),m=u[l];m.length<=o+1;)m.push(c(l,m.length-1));return(0,m[o+1])(e,t,n,a)}}}]);
//# sourceMappingURL=4033.bundle.633e77b928de84dfaa50.js.map