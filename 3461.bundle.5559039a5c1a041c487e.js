"use strict";(globalThis.webpackChunk=globalThis.webpackChunk||[]).push([[3461],{74137:(e,n,t)=>{t.d(n,{Ay:()=>c,bY:()=>i,n7:()=>s,sh:()=>r});var a=t(14041);const{CodeScheme:o}=a.QX.Cornerstone3D,r={POINT:"POINT",MULTIPOINT:"MULTIPOINT",POLYLINE:"POLYLINE",CIRCLE:"CIRCLE",ELLIPSE:"ELLIPSE"},s={ImagingMeasurementReport:"126000",ImageLibrary:"111028",ImagingMeasurements:"126010",MeasurementGroup:"125007",ImageLibraryGroup:"126200",TrackingUniqueIdentifier:"112040",TrackingIdentifier:"112039",Finding:"121071",FindingSite:"G-C0E3",FindingSiteSCT:"363698007"},i={SRT:"SRT",SCT:"SCT",CornerstoneCodeSchemes:[o.CodingSchemeDesignator,"CST4"]},c={CodeNameCodeSequenceValues:s,CodingSchemeDesignators:i,RelationshipType:{INFERRED_FROM:"INFERRED FROM",CONTAINS:"CONTAINS"},SCOORDTypes:r}},93461:(e,n,t)=>{t.r(n),t.d(n,{Enums:()=>u.Ay,createReferencedImageDisplaySet:()=>de.A,default:()=>pe,hydrateStructuredReport:()=>K,srProtocol:()=>$,toolNames:()=>g});var a=t(86326),o=t(42356),r=t(68523),s=t(71903),i=t(14041),c=t(4667),l=t(15327),d=t(3823),u=t(74137);const S=1e-4,m=({GraphicData:e,ValueType:n,imageId:t})=>{const a=[];if("SCOORD3D"===n)for(let n=0;n<e.length;n+=3)a.push([e[n],e[n+1],e[n+2]]);else for(let n=0;n<e.length;n+=2){const o=l.utilities.imageToWorldCoords(t,[e[n],e[n+1]]);a.push(o)}return a};const p=function({GraphicType:e,GraphicData:n,ValueType:t,imageId:a}){let o=[];switch(e){case u.sh.POINT:case u.sh.MULTIPOINT:case u.sh.POLYLINE:o=m({GraphicData:n,ValueType:t,imageId:a});break;case u.sh.CIRCLE:{const e=m({GraphicData:n,ValueType:t,imageId:a});if(!a)return e;const r=e[0],s=e[1],i=d.eR.distance(r,s),c=l.metaData.get("imagePlaneModule",a);if(!c)throw new Error("No imagePlaneModule found");const{columnCosines:u,rowCosines:S}=c,p=d.eR.create();d.eR.scaleAndAdd(p,r,u,i);const g=d.eR.create();d.eR.scaleAndAdd(g,r,u,-i);const f=d.eR.create();d.eR.scaleAndAdd(f,r,S,i);const I=d.eR.create();d.eR.scaleAndAdd(I,r,S,-i),o=[p,g,f,I];break}case u.sh.ELLIPSE:{const e=m({GraphicData:n,ValueType:t,imageId:a});if(!a)return e;const r=d.eR.fromValues(...e[0]),s=d.eR.fromValues(...e[1]),i=d.eR.fromValues(...e[2]),c=d.eR.fromValues(...e[3]),u=d.eR.create();d.eR.sub(u,s,r),d.eR.normalize(u,u);const p=d.eR.create();d.eR.sub(p,c,i),d.eR.normalize(p,p);const g=l.metaData.get("imagePlaneModule",a);if(!g)throw new Error("imageId does not have imagePlaneModule metadata");const{columnCosines:f}=g,I=d.eR.fromValues(...f),h=Math.abs(d.eR.dot(I,u)),R=Math.abs(d.eR.dot(I,p)),C=Math.abs(h),D=Math.abs(R);o=[],Math.abs(C-1)<S?o=[e[0],e[1],e[2],e[3]]:Math.abs(D-1)<S?o=[e[2],e[3],e[0],e[1]]:console.warn("OBLIQUE ELLIPSE NOT YET SUPPORTED");break}default:console.warn("Unsupported GraphicType:",e)}return o},g={DICOMSRDisplay:"DICOMSRDisplay",SRLength:"SRLength",SRBidirectional:"SRBidirectional",SREllipticalROI:"SREllipticalROI",SRCircleROI:"SRCircleROI",SRArrowAnnotate:"SRArrowAnnotate",SRAngle:"SRAngle",SRCobbAngle:"SRCobbAngle",SRRectangleROI:"SRRectangleROI",SRPlanarFreehandROI:"SRPlanarFreehandROI"},{MeasurementReport:f}=i.QX.Cornerstone3D;function I({measurement:e,imageId:n=null,frameNumber:t=null,displaySet:a}){let o=g.DICOMSRDisplay;const r=e.coords.reduce((e,t)=>(e[t.GraphicType]=e[t.GraphicType]||[],e[t.GraphicType].push(p({...t,imageId:n})),e),{}),{TrackingUniqueIdentifier:s}=e,{ValueType:i,GraphicType:d}=e.coords[0],u=r[d];let S=null,m=null;if(n){const e=l.metaData.get("imagePlaneModule",n);S=e?.frameOfReferenceUID}"SCOORD3D"===i&&(S=e.coords[0].ReferencedFrameOfReferenceSequence,m={FrameOfReferenceUID:S,point:u[0][0]}),e.viewReference={planeRestriction:m,FrameOfReferenceUID:S,referencedImageId:n};const f={annotationUID:s,highlighted:!1,isLocked:!1,isPreview:o===g.DICOMSRDisplay,invalidated:!1,metadata:{toolName:o,planeRestriction:m,valueType:i,graphicType:d,FrameOfReferenceUID:S,referencedImageId:n,displaySetInstanceUID:a.displaySetInstanceUID},data:{label:e.labels?.[0]?.value||void 0,displayText:e.displayText||void 0,handles:{textBox:e.textBox??{},points:u[0]},cachedStats:{},frameNumber:t,renderableData:r,TrackingUniqueIdentifier:s,labels:e.labels}};c.annotation.state.addAnnotation(f)}const{MeasurementReport:h}=i.QX.Cornerstone3D;const R=JSON.parse('{"UU":"@ohif/extension-cornerstone-dicom-sr"}').UU,C="dicom-sr",D=`${R}.sopClassHandlerModule.${C}`,T="dicom-sr-3d",O=`${R}.sopClassHandlerModule.${T}`,{sopClassDictionary:y}=o.Wp,{CORNERSTONE_3D_TOOLS_SOURCE_NAME:E,CORNERSTONE_3D_TOOLS_SOURCE_VERSION:U}=s.Enums,{MetadataProvider:N}=o.Ly,{TEXT_ANNOTATION_POSITION:b,COMMENT_CODE:M,CodeScheme:w}=i.QX.Cornerstone3D,v=[y.BasicTextSR,y.EnhancedSR,y.ComprehensiveSR,y.Comprehensive3DSR];function P(e,n){return this.instances.push(...e),o.Wp.sortStudyInstances(this.instances),this.instance=this.instances[this.instances.length-1],this.isLoaded=!1,this}function A(e,n,t){if(!e||!e.length)throw new Error("No instances were provided");o.Wp.sortStudyInstances(e);const a=e[e.length-1],{StudyInstanceUID:s,SeriesInstanceUID:i,SOPInstanceUID:c,SeriesDescription:l,SeriesNumber:d,SeriesDate:S,SeriesTime:m,ConceptNameCodeSequence:p,SOPClassUID:g,imageId:f}=a;((e,n)=>{n.forEach(n=>{if(n.StudyInstanceUID!==e)throw console.warn("Not all instances have the same UID",e,n),new Error(`Instances ${n.SOPInstanceUID} does not belong to ${e}`)})})(a.StudyInstanceUID,e);const I=g===y.Comprehensive3DSR,R=p?.CodeValue===u.n7.ImagingMeasurementReport,C={Modality:"SR",displaySetInstanceUID:o.Wp.guid(),SeriesDescription:l,SeriesNumber:d,SeriesDate:S,SeriesTime:m,SOPInstanceUID:c,SeriesInstanceUID:i,StudyInstanceUID:s,SOPClassHandlerId:I?O:D,SOPClassUID:g,instances:e,referencedImages:null,measurements:null,isDerivedDisplaySet:!0,isLoaded:!1,isImagingMeasurementReport:R,sopClassUids:v,instance:a,predecessorImageId:f,addInstances:P,label:l||`${r.A.t("Series")} ${d} - ${r.A.t("SR")}`};return C.load=()=>async function(e,n,t){const{displaySetService:a,measurementService:o}=n.services,r=t.getDataSources(),s=r[0],{ContentSequence:i}=e.instance;async function c(n,t=null,a=null){for(const o in n)if("object"==typeof n[o]&&null!==n[o])await c(n[o],n,o);else if(Array.isArray(n[o]))await Promise.all(n[o].map(e=>c(e,n,o)));else if("BulkDataURI"===o){const r=await s.retrieve.bulkDataURI({BulkDataURI:n[o],StudyInstanceUID:e.instance.StudyInstanceUID,SeriesInstanceUID:e.instance.SeriesInstanceUID,SOPInstanceUID:e.instance.SOPInstanceUID});t&&a&&(t[a]=new Float32Array(r))}}!0!==e.isLoaded&&await c(i);e.isImagingMeasurementReport?(e.referencedImages=function(e){const n=e.find(e=>e.ConceptNameCodeSequence.CodeValue===u.n7.ImageLibrary);if(!n)return[];const t=x(n.ContentSequence).find(e=>e.ConceptNameCodeSequence.CodeValue===u.n7.ImageLibraryGroup);if(!t)return[];const a=[];return x(t.ContentSequence).forEach(e=>{const{ReferencedSOPSequence:n}=e;if(n)for(const e of x(n))if(e.ReferencedSOPClassUID){const{ReferencedSOPClassUID:n,ReferencedSOPInstanceUID:t}=e;a.push({ReferencedSOPClassUID:n,ReferencedSOPInstanceUID:t})}}),a}(i),e.measurements=function(e){const n=e.find(e=>e.ConceptNameCodeSequence.CodeValue===u.n7.ImagingMeasurements);if(!n)return[];const t=function(e){const n={};return e.forEach(e=>{const t=x(e.ContentSequence),a=t.find(e=>e.ConceptNameCodeSequence.CodeValue===u.n7.TrackingUniqueIdentifier);a||console.warn("No Tracking Unique Identifier, skipping ambiguous measurement.");const o=a.UID;void 0===n[o]?n[o]=[...t]:t.forEach(e=>{e.ConceptNameCodeSequence.CodeValue!==u.n7.TrackingUniqueIdentifier&&n[o].push(e)})}),n}(x(n.ContentSequence).filter(e=>e.ConceptNameCodeSequence.CodeValue===u.n7.MeasurementGroup)),a=[];return Object.keys(t).forEach(e=>{const n=function(e){if(e.some(e=>function(e){return"SCOORD"===e.ValueType||"SCOORD3D"===e.ValueType}(e)&&!function(e){const n=e.ConceptNameCodeSequence[0];return n&&n.CodeValue===b.value&&n.CodingSchemeDesignator===b.schemeDesignator}(e)))return function(e){const n=e.find(e=>"SCOORD"===e.ValueType||"SCOORD3D"===e.ValueType),t=e.find(e=>"UIDREF"===e.ValueType),a=e.find(e=>e.ConceptNameCodeSequence.CodeValue===u.n7.TrackingIdentifier);if(!n)return void console.warn(`graphic ValueType ${n.ValueType} not currently supported, skipping annotation.`);const o=e.filter(e=>"NUM"===e.ValueType),{ConceptNameCodeSequence:r}=n,{CodeValue:s,CodingSchemeDesignator:i}=r,c=`${i}:${s}`,l=F(n),d="SCOORD3D"===l.ValueType,S=d?3:2,m=l.GraphicData.length/S,p={loaded:!1,labels:[],coords:[l],TrackingUniqueIdentifier:t.UID,TrackingIdentifier:a.TextValue,graphicCode:c,is3DMeasurement:d,pointsLength:m,graphicType:l.GraphicType};o.forEach(e=>{const{ConceptNameCodeSequence:n,MeasuredValueSequence:t}=e;t&&p.labels.push(k(n,t))});const g=e.filter(e=>e.ConceptNameCodeSequence.CodingSchemeDesignator===u.bY.SCT&&e.ConceptNameCodeSequence.CodeValue===u.n7.FindingSiteSCT);g.length&&p.labels.push({label:u.n7.FindingSiteSCT,value:g[0].ConceptCodeSequence.CodeMeaning});return p}(e);return function(e){const n=e.filter(e=>"NUM"===e.ValueType),t=e.find(e=>"UIDREF"===e.ValueType),a=e.find(e=>e.ConceptNameCodeSequence.CodeValue===u.n7.TrackingIdentifier),o=e.find(e=>e.ConceptNameCodeSequence.CodeValue===u.n7.Finding),r=e.filter(e=>e.ConceptNameCodeSequence.CodingSchemeDesignator===u.bY.SRT&&e.ConceptNameCodeSequence.CodeValue===u.n7.FindingSite),s=e.filter(e=>e.ConceptNameCodeSequence.CodingSchemeDesignator===M.schemeDesignator&&e.ConceptNameCodeSequence.CodeValue===M.value),i={loaded:!1,labels:[],coords:[],TrackingUniqueIdentifier:t.UID,TrackingIdentifier:a.TextValue};if(s)for(const e of s)e.TextValue&&i.labels.push({label:e.TextValue,value:""});o&&u.bY.CornerstoneCodeSchemes.includes(o.ConceptCodeSequence.CodingSchemeDesignator)&&o.ConceptCodeSequence.CodeValue===w.codeValues.CORNERSTONEFREETEXT&&i.labels.push({label:w.codeValues.CORNERSTONEFREETEXT,value:o.ConceptCodeSequence.CodeMeaning});if(r.length){const e=r.find(e=>u.bY.CornerstoneCodeSchemes.includes(e.ConceptCodeSequence.CodingSchemeDesignator)&&e.ConceptCodeSequence.CodeValue===w.codeValues.CORNERSTONEFREETEXT);e&&i.labels.push({label:w.codeValues.CORNERSTONEFREETEXT,value:e.ConceptCodeSequence.CodeMeaning})}return n.forEach(e=>{const{ConceptNameCodeSequence:n,ContentSequence:t,MeasuredValueSequence:a}=e,{ValueType:o}=t;if("SCOORD"===!o)return void console.warn(`Graphic ${o} not currently supported, skipping annotation.`);const r=F(t);r&&i.coords.push(r),a&&i.labels.push(k(n,a))}),i}(e)}(t[e]);n&&a.push(n)}),a}(i)):(e.referencedImages=[],e.measurements=[]);const{predecessorImageId:l}=e;for(const n of e.measurements)n.predecessorImageId=l;const d=o.getSourceMappings(E,U);e.isHydrated=!1,e.isRehydratable=function(e,n){if(!n||!n.length)return!1;const t=new Set;for(const e of n)t.add(e.annotationType);const{measurements:a}=e;for(let e=0;e<a.length;e++){const n=a[e];if(!n)continue;const{TrackingIdentifier:o="",graphicType:r,graphicCode:s,pointsLength:i}=n;if(!o&&!r){console.warn("No tracking identifier  or graphicType for measurement ",n);continue}const c=h.getAdapterForTrackingIdentifier(o),l=h.getAdaptersForTypes(s,r,i),d=c&&t.has(c.toolType)||l&&l.some(e=>t.has(e.toolType));if(d)return!0;console.log("Measurement is not rehydratable",o,a[e])}return console.log("No measurements found which were rehydratable"),!1}(e,d),e.isLoaded=!0,a.activeDisplaySets.forEach(t=>{L(e,t,s,n)}),a.subscribe(a.EVENTS.DISPLAY_SETS_ADDED,t=>{const{displaySetsAdded:a}=t;a.forEach(t=>{L(e,t,s,n)})})}(C,n,t),[C]}function V({measurement:e,displaySet:n}){return e.coords[0].ReferencedFrameOfReferenceSequence===n.FrameOfReferenceUID}function L(e,n,t,a){const{customizationService:o}=a.services,r=e.measurements.filter(e=>!1===e.loaded);if(!r.length||n.unsupported)return;const s=new Map,i=t.getImageIdsForDisplaySet(n);for(const e of i){const{SOPInstanceUID:n,frameNumber:t}=N.getUIDsFromImageID(e),a=`${n}:${t||1}`;s.set(a,e)}if(!r?.length)return;const c=e.SOPClassUID===y.Comprehensive3DSR;for(let t=r.length-1;t>=0;t--){let a=r[t];const i="SCOORD3D"===a.coords?.[0]?.ValueType,l=o.getCustomization("onBeforeSRAddMeasurement");if("function"==typeof l&&(a=l({measurement:a,StudyInstanceUID:e.StudyInstanceUID,SeriesInstanceUID:e.SeriesInstanceUID})),c&&i&&V({measurement:a,displaySet:n})){I({measurement:a,displaySet:n}),a.loaded=!0,a.displaySetInstanceUID=n.displaySetInstanceUID,r.splice(t,1);continue}const d=a.coords[0].ReferencedSOPSequence;if(!d)continue;const{ReferencedSOPInstanceUID:u}=d,S=d.ReferencedFrameNumber||1,m=`${u}:${S}`,p=s.get(m);p&&q(a,u,S)&&(I({measurement:a,imageId:p,frameNumber:S,displaySet:n}),a.loaded=!0,a.imageId=p,a.displaySetInstanceUID=n.displaySetInstanceUID,a.ReferencedSOPInstanceUID=u,a.frameNumber=S,r.splice(t,1))}}function q(e,n,t){const{coords:a}=e,o=e.coords[0].ReferencedSOPSequence&&e.coords[0].ReferencedSOPSequence?.ReferencedFrameNumber||1;if(t&&Number(t)!==Number(o))return!1;for(let e=0;e<a.length;e++){const t=a[e],{ReferencedSOPInstanceUID:o}=t.ReferencedSOPSequence;if(o===n)return!0}return!1}const F=e=>{const{ValueType:n,GraphicType:t,GraphicData:a}=e,o={ValueType:n,GraphicType:t,GraphicData:a};return o.ReferencedSOPSequence=e.ContentSequence?.ReferencedSOPSequence,o.ReferencedFrameOfReferenceSequence=e.ReferencedFrameOfReferenceUID||e.ContentSequence?.ReferencedFrameOfReferenceSequence,o};function k(e,n){const{CodeMeaning:t}=e,{NumericValue:a,MeasurementUnitsCodeSequence:o}=n,{CodeValue:r}=o;return{label:t,value:`${a?Number(a).toFixed(2):""} ${r}`}}function x(e){return e?Array.isArray(e)?e:[e]:[]}const B=function(e){const{servicesManager:n,extensionManager:t}=e,a=e=>A(e,n,t);return[{name:C,sopClassUids:v,getDisplaySetsFromSeries:a},{name:T,sopClassUids:[y.Comprehensive3DSR],getDisplaySetsFromSeries:a}]},$={id:"@ohif/sr",name:"SR Key Images",protocolMatchingRules:[],toolGroupIds:["default"],numberOfPriorsReferenced:0,defaultViewport:{viewportOptions:{viewportType:"stack",toolGroupId:"default",allowUnmatchedView:!0},displaySets:[{id:"srDisplaySetId",matchedDisplaySetsIndex:-1}]},displaySetSelectors:{srDisplaySetId:{seriesMatchingRules:[{attribute:"Modality",constraint:{equals:"SR"}}]}},stages:[{name:"SR Key Images",viewportStructure:{layoutType:"grid",properties:{rows:1,columns:1}},viewports:[{viewportOptions:{allowUnmatchedView:!0},displaySets:[{id:"srDisplaySetId"}]}]}]};var G=t(5842);const _=function(e,n){const t={};function a(a,o){const r=a.metadata?.referencedImageId??i.W6;t[r]||(t[r]={});const s=t[r];s[o]||(s[o]={data:[]});const c=e.find(e=>e.uid===a.annotationUID),l=s[o].data;let{finding:d}=c;const u=[];c.label&&(n.includes(o)?d={CodeValue:"CORNERSTONEFREETEXT",CodingSchemeDesignator:"CORNERSTONEJS",CodeMeaning:c.label}:u.push({CodeValue:"CORNERSTONEFREETEXT",CodingSchemeDesignator:"CORNERSTONEJS",CodeMeaning:c.label})),c.findingSites&&u.push(...c.findingSites);const S=Object.assign({},a,{finding:d,findingSites:u});l.push(S)}const o=e.map(e=>e.uid).slice(),r=c.annotation.state.getAnnotationManager(),s=r.getFramesOfReference();for(let e=0;e<s.length;e++){const n=s[e],i=r.getAnnotations(n),c=Object.keys(i);for(let e=0;e<c.length;e++){const n=c[e],r=i[n];if(r)for(let e=0;e<r.length;e++){const s=r[e],i=o.findIndex(e=>e===s.annotationUID);if(-1!==i&&(a(s,n),o.splice(i,1),!o.length))return t}}}return t},{CodeScheme:W}=i.QX.Cornerstone3D;const{locking:H}=c.annotation,{guid:X}=o.Ay.utils,{MeasurementReport:z}=i.QX.Cornerstone3D,{CORNERSTONE_3D_TOOLS_SOURCE_NAME:j,CORNERSTONE_3D_TOOLS_SOURCE_VERSION:Y}=s.Enums,Q=(e,n)=>{if(!n||"CORNERSTONEJS"===n.CodingSchemeDesignator)return;const t=`${n.CodingSchemeDesignator}:${n.CodeValue}`;return{...e[t],ref:t,...n,text:n.CodeMeaning}},J=(e,n)=>{if(!n||!n.length)return;const t=[];for(let a=0;a<n.length;a++){const o=Q(e,n[a][0]||n[a]);o&&t.push(o)}return t.length&&t||void 0};function K({servicesManager:e,extensionManager:n,commandsManager:t},a){const r=n.getActiveDataSource()[0],{measurementService:s,displaySetService:i,customizationService:c}=e.services,d=c.getCustomization("codingValues"),u=c.getCustomization("panelMeasurement.disableEditing"),S=i.getDisplaySetByUID(a),{StudyInstanceUID:m,SeriesInstanceUID:p,instance:{SOPInstanceUID:g}}=S,f=s.getSourceMappings(j,Y);if(!f||!f.length)throw new Error("Attempting to hydrate measurements service when no mappings present. This shouldn't be reached.");const I=o.H8.getInstance(m,p,g),h={};S.measurements.forEach(e=>{const{ReferencedSOPInstanceUID:n,imageId:t,frameNumber:a=1}=e,o=`${n}:${a}`;h[o]||(h[o]=t)});const R=I;let C=z.generateToolState(R,h,l.metaData);const D=c.getCustomization("onBeforeSRHydration")?.value;"function"==typeof D&&(C=D({storedMeasurementByAnnotationType:C,displaySet:S}));const T=f.map(e=>e.annotationType),O={};Object.keys(C).forEach(e=>{T.includes(e)&&(O[e]=C[e])});const y=[];let E;Object.keys(O).forEach(e=>{O[e].forEach(e=>{const n=e.annotation.data?.frameNumber||1,t=h[`${e.sopInstanceUid}:${n}`];y.includes(t)||y.push(t)})});const U=[];for(let e=0;e<y.length;e++){const n=y[e];if(!n)continue;const{SeriesInstanceUID:t,StudyInstanceUID:a}=l.metaData.get("instance",n);U.includes(t)||U.push(t),E?E!==a&&console.warn("NO SUPPORT FOR SRs THAT HAVE MEASUREMENTS FROM MULTIPLE STUDIES."):E=a}function N(n){const t=n.annotation.data&&n.annotation.data.frameNumber||1,a=h[`${n.sopInstanceUid}:${t}`];if(!a)return function(e,n){const{FrameOfReferenceUID:t}=e.annotation.metadata,{points:a}=e.annotation.data.handles,{displaySetService:o}=n.services,r=o.getDisplaySetsBy(e=>e.FrameOfReferenceUID===t);if(!r.length||!a?.length)return{FrameOfReferenceUID:t};const s=function(e,n){if(!e?.length)return void console.warn("No display set found for",n);if(1===e.length)return e[0];const t=e.find(e=>e.isReconstructable);if(t)return t;return e[0]}(r,e.annotation),i={...Z(s,a),volumeId:s.displaySetInstanceUID,FrameOfReferenceUID:t};return l.utilities.updatePlaneRestriction(a,i),i}(n,e);const o=l.metaData.get("instance",a),{FrameOfReferenceUID:r}=o;return{referencedImageId:a,FrameOfReferenceUID:r}}return Object.keys(O).forEach(e=>{O[e].forEach(n=>{n.uid=X();const a=N(n),{imageId:o}=a,i={annotationUID:n.annotation.annotationUID,data:n.annotation.data,predecessorImageId:n.predecessorImageId,metadata:{...a,toolName:e}};l.utilities.updatePlaneRestriction(i.data.handles.points,i.metadata);const c=s.getSource(j,Y);i.data.label=function(e){const{findingSites:n=[],finding:t,annotation:a}=e;if(a.data.label)return a.data.label;let o=n.find(e=>e.CodeValue===W.codeValues.CORNERSTONEFREETEXT);return o?o.CodeMeaning:t&&t.CodeValue===W.codeValues.CORNERSTONEFREETEXT?t.CodeMeaning:void 0}(n),i.data.finding=Q(d,n.finding?.[0]),i.data.findingSites=J(d,n.findingSites),i.data.findingSites?.forEach(e=>{e.type&&(i.data[e.type]=e)});const S=f.find(n=>n.annotationType===e),m=s.addRawMeasurement(c,e,{annotation:i},S.toMeasurementSchema,r);t.runCommand("updateMeasurement",{uid:m,code:i.data.finding}),u&&H.setAnnotationLocked(m,!0),o&&!y.includes(o)&&y.push(o)})}),S.isHydrated=!0,{StudyInstanceUID:E,SeriesInstanceUIDs:U}}function Z(e,n){const t=function(e){if(1===e.length||2===e.length)return e;const n=0,t=Math.ceil(e.length/4),a=Math.ceil(e.length/2),o=[e[n],e[t],e[a]];return o}(n),a=function(e){const n=1/e.length,t=d.eR.create();for(const a of e)d.eR.scaleAndAdd(t,t,a,n);return t}(t);return{cameraFocalPoint:a,viewPlaneNormal:null,viewUp:null}}const{downloadBlob:ee}=o.Wp,{MeasurementReport:ne}=i.QX.Cornerstone3D,{log:te}=o.Ay,ae=(e,n,t={})=>{const a=_(e,n),o=ne.generateReport(a,l.metaData,t),{dataset:r}=o;return void 0===r.SpecificCharacterSet&&(r.SpecificCharacterSet="ISO_IR 192"),r},oe=e=>{const{servicesManager:n,extensionManager:t,commandsManager:a}=e,{customizationService:r}=n.services,s={changeColorMeasurement:({uid:e})=>{throw new Error("Unsupported operation: changeColorMeasurement")},downloadReport:({measurementData:e,additionalFindingTypes:n,options:t={}})=>{const a=ae(e,n,t),o=G.Ay.data.datasetToBlob(a);ee(o,{filename:"dicom-sr.dcm"})},storeMeasurements:async({measurementData:e,dataSource:n,additionalFindingTypes:t,options:a={}})=>{if(te.info("[DICOMSR] storeMeasurements"),!n||!n.store||!n.store.dicom)return te.error("[DICOMSR] datasource has no dataSource.store.dicom endpoint!"),Promise.reject({});try{const s=ae(e,t,a),{StudyInstanceUID:i,ContentSequence:c}=s;if(!c?.[4].ContentSequence?.length)throw console.log("naturalizedReport missing imaging content",s),new Error("Invalid report, no content");if(!s.SOPClassUID)throw new Error("No sop class uid");const l=r.getCustomization("onBeforeDicomStore");let d;return"function"==typeof l&&(d=l({dicomDict:d,measurementData:e,naturalizedReport:s})),await n.store.dicom(s,null,d),i&&n.deleteStudyMetadataPromise(i),o.H8.addInstances([s],!0),s}catch(e){throw console.warn(e),te.error(`[DICOMSR] Error while saving the measurements: ${e.message}`),new Error(e.message||"Error while saving the measurements.")}},hydrateStructuredReport:({displaySetInstanceUID:e})=>K({servicesManager:n,extensionManager:t,commandsManager:a},e)};return{actions:s,definitions:{downloadReport:s.downloadReport,storeMeasurements:s.storeMeasurements,hydrateStructuredReport:s.hydrateStructuredReport},defaultContext:"CORNERSTONE_STRUCTURED_REPORT"}};var re=t(76654);class se extends c.AnnotationTool{constructor(e={},n={configuration:{}}){super(e,n),this.isPointNearTool=()=>null,this.getHandleNearImagePoint=()=>null,this.renderAnnotation=(e,n)=>{const{viewport:t}=e,{element:a}=t;let o=c.annotation.state.getAnnotations(this.getToolName(),a);if(!o?.length)return;if(o=this.filterInteractableAnnotationsForElement(a,o),!o?.length)return;const r=(0,re.eF)(a),{activeIndex:s,trackingUniqueIdentifiers:i}=r,l=i[s],d=o.filter(e=>i.includes(e.data?.TrackingUniqueIdentifier));if(!t._actors?.size)return;const S={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id},{style:m}=c.annotation.config;for(let e=0;e<d.length;e++){const a=d[e],o=a.annotationUID,{renderableData:r,TrackingUniqueIdentifier:s}=a.data,{referencedImageId:i}=a.metadata;S.annotationUID=o;const p=m.getToolGroupToolStyles(this.toolGroupId)[this.getToolName()],g=this.getStyle("lineWidth",S,a),f=this.getStyle("lineDash",S,a),I={color:s===l?"rgb(0, 255, 0)":this.getStyle("color",S,a),lineDash:f,lineWidth:g,...p};Object.keys(r).forEach(e=>{const s=r[e];let l,d;switch(e){case u.sh.POINT:l=this.renderPoint;break;case u.sh.MULTIPOINT:l=this.renderMultipoint;break;case u.sh.POLYLINE:l=this.renderPolyLine;break;case u.sh.CIRCLE:l=this.renderEllipse;break;case u.sh.ELLIPSE:l=this.renderEllipse,d=c.utilities.math.ellipse.getCanvasEllipseCorners;break;default:throw new Error(`Unsupported GraphicType: ${e}`)}const m=l(n,t,s,o,i,I);this.renderTextBox(n,t,m,d,a,S,I)})}}}_getTextBoxLinesFromLabels(e){const n=Math.min(e.length,5),t=[];for(let a=0;a<n;a++){const n=e[a];t.push(`${ce(n.label)}: ${n.value}`)}return t}renderPolyLine(e,n,t,a,o,r){const s={color:r.color,width:r.lineWidth,lineDash:r.lineDash};let i=[];return t.map((t,o)=>{const r=t.map(e=>n.worldToCanvas(e)),l=`${o}`;2===r.length?c.drawing.drawLine(e,a,l,r[0],r[1],s):c.drawing.drawPolyline(e,a,l,r,s),i=i.concat(r)}),i}renderMultipoint(e,n,t,a,o,r){let s;t.map((t,o)=>{s=t.map(e=>n.worldToCanvas(e));c.drawing.drawHandles(e,a,"0",s,{color:r.color})})}renderPoint(e,n,t,a,o,r){const s=[];return t.map((t,i)=>{const d=t[0];if(s.push(n.worldToCanvas(d)),void 0!==t[1])s.push(n.worldToCanvas(t[1]));else{const e=l.metaData.get("imagePixelModule",o);let t=10,a=10;if(e){const{columns:n,rows:o}=e;t=n/10,a=o/10}const r=l.utilities.worldToImageCoords(o,d),i=l.utilities.imageToWorldCoords(o,[r[0]+t,r[1]+a]);s.push(n.worldToCanvas(i))}const u=`${i}`;c.drawing.drawArrow(e,a,u,s[1],s[0],{color:r.color,width:r.lineWidth})}),s}renderEllipse(e,n,t,a,o,r){let s;return t.map((t,o)=>{if(0===t.length)return;const i=t,l=n.getRotation();let d;s=i.map(e=>n.worldToCanvas(e)),d=90==l||270==l?c.utilities.math.ellipse.getCanvasEllipseCorners([s[2],s[3],s[0],s[1]]):c.utilities.math.ellipse.getCanvasEllipseCorners(s);const u=`${o}`;c.drawing.drawEllipse(e,a,u,d[0],d[1],{color:r.color,width:r.lineWidth,lineDash:r.lineDash})}),s}renderTextBox(e,n,t,a,o,r,s={}){if(!t||!o)return;const{annotationUID:i,data:l={}}=o,{labels:d}=l,{color:u}=s;let S=t;"function"==typeof a&&(S=a(t));const m=this._getTextBoxLinesFromLabels(d),p=c.utilities.drawing.getTextBoxCoordsCanvas(S);o.data?.handles?.textBox?.worldPosition||(o.data.handles.textBox.worldPosition=n.canvasToWorld(p));const g=n.worldToCanvas(o.data.handles.textBox.worldPosition),f=this.getLinkedTextBoxStyle(r,o),I=c.drawing.drawLinkedTextBox(e,i,"1",m,g,t,{},{...f,color:u}),{x:h,y:R,width:C,height:D}=I;o.data.handles.textBox.worldBoundingBox={topLeft:n.canvasToWorld([h,R]),topRight:n.canvasToWorld([h+C,R]),bottomLeft:n.canvasToWorld([h,R+D]),bottomRight:n.canvasToWorld([h+C,R+D])}}}se.toolName=g.DICOMSRDisplay;const ie={"Short Axis":"W: ","Long Axis":"L: ",AREA:"Area: ",Length:"",CORNERSTONEFREETEXT:""};function ce(e){const n=ie[e];return void 0!==n?n:e}function le(e,n,t={}){class a extends n{constructor(e,n){e.configuration=e.configuration?{...e.configuration,...t}:t,super(e,n)}}a.toolName=e,(0,c.addTool)(a)}var de=t(92643);function ue(){return ue=Object.assign?Object.assign.bind():function(e){for(var n=1;n<arguments.length;n++){var t=arguments[n];for(var a in t)({}).hasOwnProperty.call(t,a)&&(e[a]=t[a])}return e},ue.apply(null,arguments)}const Se=a.lazy(()=>t.e(2701).then(t.bind(t,62701))),me=e=>a.createElement(a.Suspense,{fallback:a.createElement("div",null,"Loading...")},a.createElement(Se,e)),pe={id:R,onModeEnter:function({servicesManager:e}){const{displaySetService:n}=e.services;[...n.getDisplaySetCache().values()].filter(e=>e.SOPClassHandlerId===D||e.SOPClassHandlerId===O).forEach(e=>{e.isHydrated=!1})},preRegistration:function({configuration:e={},servicesManager:n}){le(g.DICOMSRDisplay,se),le(g.SRLength,c.LengthTool),le(g.SRBidirectional,c.BidirectionalTool),le(g.SREllipticalROI,c.EllipticalROITool),le(g.SRCircleROI,c.CircleROITool),le(g.SRArrowAnnotate,c.ArrowAnnotateTool),le(g.SRAngle,c.AngleTool),le(g.SRPlanarFreehandROI,c.PlanarFreehandROITool),le(g.SRRectangleROI,c.RectangleROITool),le(g.SRCobbAngle,c.CobbAngleTool);const t={lineDash:"4,4"};c.annotation.config.style.setToolGroupToolStyles("SRToolGroup",{[g.DICOMSRDisplay]:t,SRLength:t,SRBidirectional:t,SREllipticalROI:t,SRCircleROI:t,SRArrowAnnotate:t,SRCobbAngle:t,SRAngle:t,SRPlanarFreehandROI:t,SRRectangleROI:t,global:{}})},getViewportModule:({servicesManager:e,extensionManager:n})=>[{name:"dicom-sr",component:t=>a.createElement(me,ue({servicesManager:e,extensionManager:n},t))}],getCommandsModule:oe,getSopClassHandlerModule:B,getUtilityModule:({servicesManager:e})=>[{name:"tools",exports:{toolNames:g}}]}},76654:(e,n,t)=>{t.d(n,{eF:()=>s,m1:()=>r});var a=t(15327);const o={TrackingUniqueIdentifier:null,trackingIdentifiersByViewportId:{}};function r(e,n,t=0){const r=(0,a.getEnabledElement)(e),{viewport:s}=r;o.trackingIdentifiersByViewportId[s.id]={trackingUniqueIdentifiers:n,activeIndex:t}}function s(e){const n=(0,a.getEnabledElement)(e),{viewport:t}=n;return o.trackingIdentifiersByViewportId[t.id]?o.trackingIdentifiersByViewportId[t.id]:{trackingUniqueIdentifiers:[]}}},92643:(e,n,t)=>{t.d(n,{A:()=>s});const a=t(42356).Ly.ImageSet,o=(e,n)=>{const{displaySetInstanceUID:t,ReferencedSOPInstanceUID:a}=e,o=n.getDisplaySetByUID(t);if(o.images)return o.images.find(e=>e.SOPInstanceUID===a)},r=(e,n)=>{const t=[],a={};for(const r of n.measurements){const{imageId:n}=r;if(!n)continue;if(a[n])continue;const s=o(r,e);s?(a[n]=s,t.push(s)):console.log("Measurement",r,"had no instances found")}return t},s=(e,n)=>{const t=r(e,n),o=new a(t),s=t[0];if(s)return o.setAttributes({displaySetInstanceUID:o.uid,SeriesDate:s.SeriesDate,SeriesTime:s.SeriesTime,SeriesInstanceUID:o.uid,StudyInstanceUID:s.StudyInstanceUID,SeriesNumber:s.SeriesNumber||0,SOPClassUID:s.SOPClassUID,SeriesDescription:`${n.SeriesDescription} KO ${n.instance.SeriesNumber}`,Modality:"KO",isMultiFrame:!1,numImageFrames:t.length,SOPClassHandlerId:"@ohif/extension-default.sopClassHandlerModule.stack",isReconstructable:!1,isCompositeStack:!0,madeInClient:!0,excludeFromThumbnailBrowser:!0,updateInstances:function(){this.images.splice(0,this.images.length,...r(e,n)),this.numImageFrames=this.images.length}}),e.addDisplaySets(o),o}}}]);
//# sourceMappingURL=3461.bundle.5559039a5c1a041c487e.js.map